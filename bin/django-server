#!/bin/bash

if [[ -z "$HL_APP_ROOT" ]]; then
    HL_APP_ROOT=$(pwd)
fi

if [[ -z "$HL_APP_NAME" ]]; then
    HL_APP_NAME='apparelrow'
fi

# Static, should not be touched
PIDFILE="$HL_APP_ROOT/var/$HL_APP_NAME.pid"         # PID file for controlling instance
SOCKET="$HL_APP_ROOT/var/$HL_APP_NAME.sock"         # FCGI socket

if [ -z "$1" ]; then
    echo "Missing argument"
    echo "./django-server stop|start|restart"
    exit 1
fi

# FIXME: Check that this path exists
. $HL_APP_ROOT/bin/activate
cd $HL_APP_ROOT/releases/current

if ([[ "$1" == "restart" ]] || [[ "$1" == "stop" ]]); then
    for pfile in "$PIDFILE" "$PIDFILE-admin"
    do
       if [[ $pfile == "$PIDFILE-admin" ]]; then
            pname="FCGI process (admin)"
       else
            pname="FCGI process"
       fi

       if [[ -f $pfile ]]; then
            echo "Stopping $pname"
            kill `cat -- $pfile`
            rm -f -- $pfile
        elif [[ "$1" == "stop" ]]; then
            echo "No $pname running"
        fi
    done
fi


if [[ "$1" == "restart" ]] || [[ "$1" == "start" ]]; then

    echo "Starting FCGI process"
    ./manage.py runfcgi method=threaded socket=$SOCKET pidfile=$PIDFILE \
        maxspare=4 workdir=$HL_APP_ROOT

    echo "Starting FCGI process (admin)"
    ./manage.py runfcgi method=threaded socket=$SOCKET-admin pidfile=$PIDFILE-admin \
        maxspare=1 maxchildren=1 workdir=$HL_APP_ROOT
fi

