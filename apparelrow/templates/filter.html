{% extends 'base.html' %}
{% load mptt_tags %}

{% block 'extra-styles' %}
    <style type="text/css">
        .tooltip {
            display: none;
            width: 699px;
            height: 478px;
            -moz-box-shadow: 0 0 1em black;
            -webkit-box-shadow: 0 0 1em black;
            z-index: 200;
        }
    </style>
{% endblock 'extra-styles' %}
{% block 'extra-scripts' %}
    <script type="text/javascript">
        jQuery(document).ready(function() {
            // Brand search
            jQuery("input[name=brand]").keyup(function(e) {
                var s = jQuery(this).val();
                if(s == "") {
                    $('#product-manufacturers > li').show();
                    return;
                }
                $('#product-manufacturers > li').filter(function(index) {
                    return jQuery(this).text().toLowerCase().indexOf(s.toLowerCase()) < 0;
                }).hide();
                $('#product-manufacturers > li').filter(function(index) {
                    return jQuery(this).text().toLowerCase().indexOf(s.toLowerCase()) >= 0;
                }).show();
            });
            // Tooltips
            jQuery('#product-list > a').tooltip({ effect: 'slide', position: 'bottom left' });
            content = jQuery('#content');
            view = $(window);
            view.bind(
                "scroll resize",
                function() {
                    contentTop = content.parent().offset().top;
                    viewTop = view.scrollTop();
                    if(viewTop > contentTop && !content.is(".fixed")) {
                        content.height(content.height());
                        content.addClass("fixed");
                    } else if(viewTop <= contentTop && content.is(".fixed")) {
                        content.css("height", "auto");
                        content.removeClass("fixed");
                    }
                });
            /*
            if(window.location.hash) {
                doFilter(window.location.hash.substr(1));
            }
            */
            jQuery('.options').addClass('popup');
            jQuery('.options a.cancel').click(function() {
                $(this).parent().hide();
                return false;
            });
            jQuery('.options a.ok').click(function() {
                $(this).parent().hide();
                filter(getQuery());
                return false;
            });
            jQuery('#product-options > li > a').click(function() {
                $(this).next('.options').slideToggle('fast');
                return false;
            });
            jQuery('#product-options li > a').click(function() {
                jQuery(this).toggleClass('selected');
                return false;
            });
            jQuery('#product-gender li > a').click(function() {
                jQuery(this).toggleClass('selected');
                jQuery(this).parent().siblings().find('a').removeClass('selected');
                filter(getQuery());
                return false;
            });
            jQuery('#product-category li > a').click(function() {
                jQuery(this).toggleClass('selected');
                filter(getQuery());
                return false;
            });
            jQuery('#pagination .prev').click(function() {
                filter(getQuery({{ products.previous_page_number }}));
                return false;
            });
            jQuery('#pagination .next').click(function() {
                filter(getQuery({{ products.next_page_number }}));
                return false;
            });
            product_template = jQuery.template('{{ product_template|escapejs }}');

            jQuery("#price-slider").slider({
                range: true,
                min: 0,
                max: 5000,
                step: 10,
                values: [100, 2000],
                animate: 'fast',
                slide: function(event, ui) {
                    jQuery("#min-price").html(jQuery(this).slider('values', 0));
                    jQuery("#max-price").html(jQuery(this).slider('values', 1));
                },
                change: function(event, ui) {
                    filter(getQuery());
                }
            });
        });
        function getQuery(page_number) {
            index = 0;
            query = {};
            category_list = getElementIds(jQuery('#product-category li > a.selected'));
            if(category_list.length > 0) {
                query[++index + ':c.id:in'] = category_list.join(',');
            }
            manufacturer_list = getElementIds(jQuery('#product-manufacturers li > a.selected'));
            if(manufacturer_list.length > 0) {
                query[++index + ':m.id:in'] = manufacturer_list.join(',');
            }
            gender_list = getElementIds(jQuery('#product-gender li > a.selected'));
            if(gender_list.length > 0) {
                query[++index + ':o.gender:in'] = gender_list.join(',');
            }
            color_list = getElementIds(jQuery('#product-color li > a.selected'));
            if(color_list.length > 0) {
                query[++index + ':o.color:in'] = color_list.join(',');
            }
            query[++index + ':vp.price:range'] = jQuery('#price-slider').slider('values', 0) + ',' + jQuery('#price-slider').slider('values', 1);
            if(page_number) {
                query['page'] = page_number;
            }
            return query;
        }
        function getElementIds(elements) {
            return jQuery.map(elements, function(element) {
                return element.id.split('-')[1];
            });
        }
        function filter(query) {
            window.location.hash = jQuery.param(query);
            doFilter(query);
        }
        function doFilter(query) {
            jQuery.getJSON('/apparel/products/search', query, renderProducts);
        }
        function renderProducts(products) {
            jQuery('#product-list').empty();
            template.render(jQuery('#product-list'), products, product_template,
                function(obj) {
                    return template.getTemplateContext({
                        'product': {
                            'object': obj,
                            'properties': ['id', 'product_image', 'product_name', 'get_absolute_url']
                        },
                    });
                }
            );
        }
    </script>
{% endblock 'extra-scripts' %}

{% block body-classes %}two-columns{% endblock body-classes %}

{% block body %}
        <div class="sidebar">
            <h2>Bläddra bland plagg</h2>
                    <ul id="product-gender">
                        <li><a href="#">Alla</a></li>
                        {% for gender in genders %}
                        <li><a id="option-{{ gender.value }}" href="?1:o.gender={{ gender.value }}">{{ gender.value }}</a></li>
                        {% endfor %}
                    </ul>
                    <ul id="product-options">
                        <li id="product-price"><a href="#">Pris (<span id="min-price"></span>-<span id="max-price"></span>)</a>
                        {% include "fragments/product_options_price.html" %}
                        </li>
                        <li><a href="#">Färg</a>
                        {% include "fragments/product_options_color.html" %}
                        </li>
                        <li><a href="#">Märke</a>
                        {% include "fragments/product_options_brand.html" %}
                        </li>
                    </ul>
    {% for category, structure in categories|tree_info %}
    {% if structure.new_level %}<ul{% if forloop.first %} id="product-category"{% endif %}>{% else %}</li>{% endif %}<li>
        <a id="category-{{ category.id }}" href="?1:c.id:in={{ category.id }}">{{ category.name }}</a>
    {% for level in structure.closed_levels %}</li></ul>{% endfor %}
    {% endfor %}
        </div>
        <div id="content">
            <h2>{{ products.paginator.count }} produkter</h2>
            <div id="product-list" class="clearfix">
                {% for product in products.object_list %}
                    {% include 'apparel/fragments/product_small.html' %}
                    {% with product as object %}
                    <div class="tooltip">
                        {% include 'apparel/fragments/product_detail.html' %}
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
            <div id="pagination">
                {% include 'apparel/fragments/pagination.html' %}
            </div>
        </div>
{% endblock body %}
