{% extends 'base.html' %}
{% load i18n %}
{% load apparel_extras %}
{% load cache %}
{% load thumbnail %}
{% load django_static %}

{% block 'extra-scripts' %}
    <script type="text/javascript" src="{{ MEDIA_URL }}{% staticfile "js/filtersetup.js" %}"></script>
    <script type="text/javascript">
        var pricerange = {
            min: {{ pricerange.min }},
            max: {{ pricerange.max }}
        };
        
        var MAX_ANIMATE = 7;
        var ANIMATION_SPEED = 1000;
        
        jQuery(document).ready(function() {
            jQuery('.tabs')
                .tabs('#featured-looks>ul > li', {
                    initialIndex: null,
                    effect: 'fade',
                    fadeInSpeed: ANIMATION_SPEED,
                    fadeOutSpeed: ANIMATION_SPEED,
                    rotate: true,
                    history: true
                })
                .data('timerImageIndex', 0)
                .bind('onBeforeClick', function(e, idx) {
                    var tabs = jQuery('.tabs').data('tabs');
                    var tab  = tabs.getCurrentTab();
                    
                    window.clearTimeout(tab.data('tabAnimationTimer'));
                    tab.data('tabAnimationIndex', 1);
                    for(var i = 1; i <= MAX_ANIMATE; i++)
                        tab.removeClass('tab-animation-' + i);
                })
                .bind('onClick', function(e, idx) {
                    animateTab();
                })
                .slideshow()
            ;

            jQuery('#product-gender a, #product-options a').click(function(event) {
                var target = $(this).attr('href');
                if(target.indexOf('?') > 0) {
                    event.preventDefault();
                    window.location = target.replace('?', '#');
                }
            });

            jQuery('#product-category a').click(function(event) {
                var $this = $(this);
                var target = $this.attr('href');
                if(target.indexOf('?') > 0) {
                    event.preventDefault();
                    var url = target.replace('?', '#');
                    var subCategories = $this.siblings('ul');
                    if(subCategories.length > 0) {
                        var categories = $("a", subCategories).map(function(i, cat) {
                            return $(cat).attr("href").split("=").pop();
                        });
                        url += "," + categories.get().join(",");
                    }
                    window.location = url;
                }
            });
        });
        function animateTab() {
            var tabs = jQuery('.tabs').data('tabs');
            var tab  = tabs.getCurrentTab();
            var i = tab.data('tabAnimationIndex') || 1;
            
            if(i <= MAX_ANIMATE) {
                if(i > 1) tab.removeClass('tab-animation-' + (i - 1));
                tab.addClass('tab-animation-' + i);
                tab.data('tabAnimationIndex', ++i);
                tab.data('tabAnimationTimer', window.setTimeout(animateTab, ANIMATION_SPEED));
                
                return;
            }
            tabs.next();
        }
        
        /*

        */
    </script>
{% endblock 'extra-scripts' %}

{% block body-classes %}three-columns{% endblock body-classes %}

{% block body %}
    {% cache CACHE_TIMEOUT index_filter LANGUAGE_CODE APPAREL_GENDER %}
    <div class="sidebar">
        {% include 'apparel/fragments/product_menu.html' %}
    </div>
    {% endcache %}
    {% cache CACHE_TIMEOUT index LANGUAGE_CODE APPAREL_GENDER %}
    <div id="content">
        <h2>{% trans "News" %}</h2>
        <div id="featured-looks">
            <ul id="contents">
            {% for page in pages %}
                <li class="feature">
                    <div class="page">
                        {% if page.url %}<a href="{{ page.url }}">{% endif %}
                            {% if page.image %}
                                {% thumbnail page.image "450x327" crop="center" as im %}
                                <img src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" alt="{{ page.title }}" />
                                {% endthumbnail %}
                            {% else %}
                                {{ page.content|safe }}
                            {% endif %}
                        {% if page.url %}</a>{% endif %}
                    </div>
                    <div class="info-box">
                        <h3>{{ page.title }}</h3>
                        <p>{% if page.description %}{{ page.description }}{% endif %}</p>
                    </div>
                </li>
            {% endfor %}
            {% for look in featured_looks %}
                <li class="feature">
                    <a href="{{ look.get_absolute_url }}">
                        <div class="look">
                        {% if look.display_with_component == 'P' %}
                            {% thumbnail look.image "450x328" crop="center" as im %}
                            <img id="look-{{ look.id }} class="product" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                            {% endthumbnail %}
                        {% else %}
                            {% for component in look.collage_components.all %}
                                {% thumbnail component.product.product_image "450x328" crop="center" as im %}
                                <img id="product-{{ component.product.id }}" class="product collage-image" style="{{ component.style_middle }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" />
                                {% endthumbnail %}
                            {% endfor %}
                        {% endif %}
                        </div>
                    </a>
                    <div class="info-box">
                        <a href="{{ look.get_absolute_url }}" class="info">
                            <h3>{{ look.title }} {% trans "by" %} {{ look.user }}</h3>
                            <p>{{ look.description }}</p>
                        </a>
                    </div>
                </li>
            {% endfor %}
            </ul>
            <div id="switchlook">
                <a class="backward" href="#prev">{% trans "Previous" %}</a>
                <ul class="tabs">
                {% for page in pages %}
                    <li><a id="p{{ forloop.counter }}" href="#featured-page{{ forloop.counter }}">{{ page.title }}</a></li>
                {% endfor %}
                {% for look in featured_looks %}
                    <li><a id="l{{ forloop.counter }}" href="#featured-look{{ forloop.counter }}">{{ look.title }}</a></li>
                {% endfor %}
                </ul>
                <a class="forward" href="#next">{% trans "Next" %}</a>
            </div>
        </div>
    </div>
    {% endcache %}
    <div class="sidebar last">
        <a href="{% url look-list %}"><h2>{% trans "Popular looks" %}</h2></a>
        {% cache CACHE_TIMEOUT index_looks LANGUAGE_CODE APPAREL_GENDER %}
        {% with popular_looks as looks %}
            {% include 'apparel/fragments/looks_sidebar.html' %}
        {% endwith %}
        {% endcache %}
        <a href="/looks/create/" id="create-look" class="button{% if not user.is_authenticated %} open-dialog{% endif %}">{% trans "Create a look!" %}</a>
    </div>
{% endblock body %}
