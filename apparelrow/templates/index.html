{% extends 'base.html' %}
{% load i18n %}
{% load apparel_extras %}
{% load cache %}
{% load thumbnail %}

{% block 'extra-scripts' %}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/filtersetup.js"></script>
    <script type="text/javascript">
        var pricerange = {
            min: {{ pricerange.min }},
            max: {{ pricerange.max }}
        };
        
        var MAX_ANIMATE = 7;
        var ANIMATION_SPEED = 1000;
        
        jQuery(document).ready(function() {
            jQuery('.tabs')
                .tabs('#featured-looks>ul > li', {
                    initialIndex: null,
                    effect: 'fade',
                    fadeInSpeed: ANIMATION_SPEED,
                    fadeOutSpeed: ANIMATION_SPEED,
                    rotate: true,
                    history: true
                })
                .data('timerImageIndex', 0)
                .bind('onBeforeClick', function(e, idx) {
                    var tabs = jQuery('.tabs').data('tabs');
                    var tab  = tabs.getCurrentTab();
                    
                    window.clearTimeout(tab.data('tabAnimationTimer'));
                    tab.data('tabAnimationIndex', 1);
                    for(var i = 1; i <= MAX_ANIMATE; i++)
                        tab.removeClass('tab-animation-' + i);
                })
                .bind('onClick', function(e, idx) {
                    animateTab();
                })
                .slideshow()
            ;
            
            // var dialog;
            jQuery('#create-look').click(function(event) {
                if(!isAuthenticated) {
                    jQuery('#error_dialog_template')
                        .render({
                            header: '{% trans "Log in" %}',
                            messages: [
                                '{% trans "With ApparelRow you can create Looks as a collage, tagged image or a selection of clothes. You can share the Look at your blog, Facebook page or other site." %}',
                                '{% trans "To create a look you have to log in to your account."%}'
                            ]
                        })
                        .appendTo('body')
                        .overlay({
                            mask: {
                                color: '#000',
                                loadSpeed: 200,
                                opacity: 0.5
                            },
                            load: true,
                            closeOnClick: false,
                            close: '.ok',
                            top: 200,
                            onClose: function(e) { this.getTrigger().remove() }
                        })
                    ;
                    return false;
                }
                
                return true;
            });

            jQuery('#product-gender a, #product-options a').click(function(event) {
                var target = $(this).attr('href');
                if(target.indexOf('?') > 0) {
                    event.preventDefault();
                    window.location = target.replace('?', '#');
                }
            });

            jQuery('#product-category a').click(function(event) {
                var $this = $(this);
                var target = $this.attr('href');
                if(target.indexOf('?') > 0) {
                    event.preventDefault();
                    var url = target.replace('?', '#');
                    var subCategories = $this.siblings('ul');
                    if(subCategories.length > 0) {
                        var categories = $("a", subCategories).map(function(i, cat) {
                            return $(cat).attr("href").split("=").pop();
                        });
                        url += "," + categories.get().join(",");
                    }
                    window.location = url;
                }
            });
        });
        function animateTab() {
            var tabs = jQuery('.tabs').data('tabs');
            var tab  = tabs.getCurrentTab();
            var i = tab.data('tabAnimationIndex') || 1;
            
            if(i <= MAX_ANIMATE) {
                if(i > 1) tab.removeClass('tab-animation-' + (i - 1));
                tab.addClass('tab-animation-' + i);
                tab.data('tabAnimationIndex', ++i);
                tab.data('tabAnimationTimer', window.setTimeout(animateTab, ANIMATION_SPEED));
                
                return;
            }
            tabs.next();
        }
        
        /*

        */
    </script>
{% endblock 'extra-scripts' %}

{% block body-classes %}three-columns{% endblock body-classes %}

{% block body %}
    {% cache CACHE_TIMEOUT index_filter LANGUAGE_CODE request.META.QUERY_STRING %}
    <div class="sidebar">
        {% include 'apparel/fragments/product_menu.html' %}
    </div>
    {% endcache %}
    {% cache CACHE_TIMEOUT index LANGUAGE_CODE %}
    <div id="content">
        <h2>{% trans "News" %}</h2>
        <div id="featured-looks">
            <ul id="contents">
            {% for page in pages %}
                <li class="feature">
                    <div class="page">
                        {% if page.url %}<a href="{{ page.url }}">{% endif %}
                            {% if page.image %}
                                <img src="{% thumbnail page.image "450x327" crop="center" %}" width="450" height="327" alt="{{ page.title }}" />
                            {% else %}
                                {{ page.content|safe }}
                            {% endif %}
                        {% if page.url %}</a>{% endif %}
                    </div>
                    <div class="info-box"><h3>{{ page.title }}</h3></div>
                </li>
            {% endfor %}
            {% for look in featured_looks %}
                <li class="feature">
                    <a href="{{ look.get_absolute_url }}">
                        <div class="look">
                        {% with look as object %}
                        {% ifequal object.display_with_component 'P' %}
                            {% include 'apparel/fragments/look_photo_featured.html' %}
                        {% else %}
                            {% include 'apparel/fragments/look_collage_featured.html' %}
                        {% endifequal %}
                        {% endwith %}
                        </div>
                    </a>
                    <div class="info-box">
                        <a href="{{ look.get_absolute_url }}" class="info">
                            <h3>{{ look.title }} {% trans "by" %} {{ look.user }}</h3>
                            <p>{{ look.description }}</p>
                        </a>
                    </div>
                </li>
            {% endfor %}
            </ul>
            <div id="switchlook">
                <a class="backward" href="#prev">{% trans "Previous" %}</a>
                <ul class="tabs">
                {% for page in pages %}
                    <li><a id="p{{ forloop.counter }}" href="#featured-page{{ forloop.counter }}">{{ page.title }}</a></li>
                {% endfor %}
                {% for look in featured_looks %}
                    <li><a id="l{{ forloop.counter }}" href="#featured-look{{ forloop.counter }}">{{ look.title }}</a></li>
                {% endfor %}
                </ul>
                <a class="forward" href="#next">{% trans "Next" %}</a>
            </div>
        </div>
    </div>
    {% endcache %}
    {% cache CACHE_TIMEOUT index_looks LANGUAGE_CODE %}
    <div class="sidebar last">
        <h2>{% trans "Popular looks" %}</h2>
        {% with popular_looks as looks %}
            {% include 'apparel/fragments/looks_sidebar.html' %}
        {% endwith %}
        <a href="/looks/create/" id="create-look" class="button">{% trans "Create a look!" %}</a>
    </div>
    {% endcache %}
{% endblock body %}

