{% load i18n %}
{% load facebook_tags %}
{% load apparel_extras %}
<!doctype html>
<html lang="{{ lang }}">
<head>
    <title>{% block extra-title %}{% endblock %}Apparel Row</title>
    <meta charset="utf-8" />
    <link type="text/css" href="{{ MEDIA_URL }}/styles/smoothness/jquery-ui-1.8rc3.custom.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ MEDIA_URL }}/styles/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="{{ MEDIA_URL }}/styles/print.css" type="text/css" media="print">
    {% block 'extra-styles' %}
    {% endblock 'extra-styles' %}
    
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load("jquery", "1.4.2");
        google.load("jqueryui", "1.8.0");
    </script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.autogrow.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/apparel.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.hypersubmit.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.tools.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/dump.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.tmpl.js"></script>
    <script type="text/javascript">
        
        jQuery(document).ready(function() {
             jQuery('#login').click(function() {
                jQuery('#nav-main').animate({ opacity: 'toggle' }, 'fast');
                jQuery('#account-dialogue').animate({ opacity: 'toggle' }, 'fast');
                
                return false;
            });
            
            /* Toggle text field texts */
            jQuery('#account-dialogue input[type=text]').each(function() {
                if(this.name) {
                    jQuery(this).focus(function() { 
                        this.value = '';
                        jQuery(this).removeClass('default-value');
                    } );
                    
                    jQuery(this).blur(function() { 
                        if(this.value == '') {
                            this.value = this.defaultValue 
                            jQuery(this).addClass('default-value');
                        }
                    } );
                }
            });
            
            /* Toggle password box */
            jQuery('#login-password-placeholder').focus(function() {
                pwdField = jQuery('#login-password');
                jQuery(this).toggle();
                pwdField.toggle();
                pwdField.focus();
            });
            
            jQuery('#login-password').blur(function() {
                if(this.value == '') {
                    txtField = jQuery('#login-password-placeholder');
                    jQuery(this).toggle();
                    txtField.toggle();
                }
            });
            
            
            
            // Add handlers
            jQuery('#search > input').keyup(function(e) {
                // FIXME: Ignore if modifier is used (apart from shift)
                var j = jQuery(this);
                clearTimeout(j.data('tid'));
                
                switch(e.keyCode) {
                    case 0: // command+tab
                    case 9: // tab
                    case 13: // enter
                    case 17: // ctrl
                    case 18: // alt
                    case 224: // command
                        return false;
                    case 27: // escape
                        hideSearch();
                        return false;
                    
                    default:
                        j.data('tid', setTimeout(doSearch, 1000));
                }
            });
            
            /*
            jQuery('#search-result-manufacturers li > a').live('click', function(e) {
                // location.href='/browse/?1:m.id=' + this.id.split('-').pop();
                return false;
            });
            */

        });
        
        //
        // SEARCH FUNCTIONALITY
        // 
        
        function doSearch() {
            var s = jQuery('#search > input').val();
            if(s.length == 0)
                return;
            
            clearSearchResults();
            
            // Find products
            
            getSearchResults({
                model: 'products', 
                query: {
                    '1:p.product_name:icontains': s,
                    '2:p.description:icontains': s,
                    'o': '1o2',
                    'size': 6
                },
                selector: '#search-result-products',
                template: 'product_search_template'
            });

            getSearchResults({
                model: 'looks', 
                query: {
                    '1:l.title:icontains': s,
                    '2:l.description:icontains': s,
                    'o': '1o2',
                    'size': 6
                },
                selector: '#search-result-looks',
                template: 'look_search_template'
            });
            
            getSearchResults({
                model: 'manufacturers', 
                query: {
                    '1:m.name:icontains': s,
                    'size': 10
                },
                selector: '#search-result-manufacturers',
                template: 'manufacturer_search_template'
            });
            
            console.log('searching with ', s);
            showSearch();
        }
        
        function clearSearchResults() {
            jQuery('#search-result ul').empty();
        }
        
        function getSearchResults(opts) {
            /*
             * Options:
             *  model       Model to search for
             *  query       Query as dict
             *  template    Name of template for rendering results
             *  selector    Selector of UL to add results to
             */
            jQuery.ajax({
                type: 'GET',
                url: '/' + opts.model + '/search',
                dataType: 'json',
                data: opts.query,
                complete: function(request, status) {
                    console.log('Do cleanup here (hide search result etc)')
                },
                success: function(response, status, request) {
                    if(!response) return;
                    var list = jQuery(opts.selector);
                    jQuery.each(response.object_list, function(i, object) {
                        try {
                            var args, root;
                            if(opts.template == 'product_search_template') {
                                // Product template special casing
                                args = { 'product': object };
                                root = list;
                            } else {
                                args = { 'object': object };
                                root = jQuery('<li/>').appendTo(list);
                            }
                            
                            jQuery('#' + opts.template).render(args).appendTo(root);
                        } catch(e) {
                            console.log('Error while rendering template', e);
                        }
                    });
                    
                    if(list.children().size() == 0) {
                        console.log('No results');
                    }

                }
            });
        }
        
        function hideSearch() {
            jQuery('#search-result').hide();
            jQuery('#search').removeClass('expanded');
        }
        
        function showSearch() {
            jQuery('#search-result').fadeIn();
            jQuery('#search').addClass('expanded');
        }
        
        /*
        function display(data) {
            $.each(data.result, function(result_type, result) {
                var ele = jQuery('#search-result-' + result_type);
                ele.empty();
                template.render(ele, result, jQuery.template(data.templates[result_type]),
                    function(obj) {
                        return template.getTemplateContext({
                            'product': {
                                'object': obj,
                                'properties': ['id', 'product_image', 'product_name']
                            },
                        });
                    }
                );
            });
            /*
            for( var name in data.result) {
                var elem = jQuery('#search-result-' + name);
                if(!elem)
                    continue;
                
                if(!name in adders)
                    continue;
                
                elem.empty();
                
                for(var i = 0; i < data[name].length; i++)
                    adders[name](elem, data[name][i]);
            }
        }
            */
        
        // FIXME: These could be replaced with different templates to process
        /*
        adders = {
            'products': function(elem, product) {
                elem.append('<h3>' + product.product_name + '</h3>');
                elem.append('<a href="/apparel/products/' + product.id + '">Read more</a>');
            },
            'manufacturers': function(elem, manufacturer) {
                elem.append('<h3>' + manufacturer.name + '</h3>');
                elem.append('<a href="/apparel/manufacturer/' + manufacturer.id + '">Read more</a>');            
            },
            'categories': function(elem, category) {
                elem.append('<h3>' + category.name + '</h3>');
                elem.append('<a href="/apparel/products/' + category.id + '">Read more</a>');
            }
        };  
        */
    </script>
    {% block 'extra-scripts' %}
    {% endblock 'extra-scripts' %}
    {% facebook_js %}
    {% initialize_facebook_connect %}
</head>
<body class="{% block body-classes %}{% endblock %}">

<div id="header">
    <div class="container">
        
        <a href="/"><h1>ApparelRow</h1></a>
        
        <div id="account-dialogue">
            <!-- LOGIN FORM -->
            <form action="/accounts/login/" method="post" id="login-form">
                {% csrf_token %}
                <!--
                <a id="login-forgot-password" href="/accounts/password/reset/">{% trans "Forgot password?" %}</a>
                <a id="login-create-account" href="/accounts/register/">{% trans "Create account" %}</a>
                -->
                <div>
                    <input type="text" name="username" class="default-value" value="{% trans "Username" %}" id="login-username" />
                    <input type="text" value="{% trans "Password" %}" class="default-value" id="login-password-placeholder" />
                    <input type="password" name="password" id="login-password" />
                    <button type="submit" name="submit" id="login-submit">{% trans "Login" %}</button>
                    {% ifequal request.path "/accounts/logout/" %}
                        <input type="hidden" name="next" value="/" />
                    {% else %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    {% endifequal %}
                </div>
            </form>
            {# Facebook connect button #}
            {% with "/media/images/fblogo.png" as fb_connect_logo %}
                {% include "facebook/connect_button.html" %}
            {% endwith %}
        </div>
        <form action="/apparel/search" method="get" onsubmit="return false" id="search">
            <input type="text" name="s" />
            <div id="search-result">
                <div class="col-2">
                    <h2>{% trans "Matching products" %}</h2>
                    <ul id="search-result-products"></ul>
                </div>
                <div>
                    <h2>{% trans "Matching looks" %}</h2>
                    <ul id="search-result-looks" class="looks"></ul>
                </div>
                <div class="last">
                    <h2>{% trans "Matching brands" %}</h2>
                    <ul id="search-result-manufacturers"></ul>
                </div>
            </div>
        </form>
        
        <ul id="nav-main">
        <!--
            <li><a href="/">{% trans "Home" %}</a></li>            
        -->
        {% if user.is_authenticated %}
            <!-- FIXME: Put this back as soon as we've got the whole profile thing working
                <li><a href="/profile/"{% ifequal request.path "/apparel/profile/" %} class="selected"{% endifequal %}>{% trans "My Profile" %}</a></li>
            <li><a href="#">{% trans "My Profile" %}</a></li>            
         -->
           {% else %}
            <li><a href="/accounts/login/" id="login">{% trans "Login" %}</a></li>
            <li><a href="/accounts/register/" id="login">{% trans "Sign up" %}</a></li>
        {% endif %}
        </ul>
    </div>
</div>


<div id="container">
    <div class="container">
{% if user.is_authenticated and user.get_profile %}
<div id="login-pane">
    <div class="container">
    <a href="/accounts/logout/" id="logout">{% trans "Logout" %}</a>
    <span id="logged-in-as">
        {% trans "Logged in as" %}: <strong>{{ user.get_profile.display_name }}</strong>
    </span>
    <ul id="nav-user">
    </ul>
    </div>
</div>
{% endif %}

    {% block body %}
    {% endblock %}
    </div>
</div>
<div id="footer">
    <div class="container">
    </div>
</div>
{% for template_name,template_string in templates.items %}
    <script type="text/html" id="{{ template_name }}_template">
        {{ template_string|safe }}
    </script>
{% endfor %}
{% comment %}
    FIXME: Would be neat if there is a way of combining templates and default_templates
    so we do not have to iterate twice. Preferably, this should be done in the
    context processor (just not sure how to get the current context from the request)
   or in the template (default_templates.update(template).items or something
{% endcomment %}
{% for template_name,template_string in default_templates.items %}
    <script type="text/html" id="{{ template_name }}_template">
        {{ template_string|safe }}
    </script>
{% endfor %}
</body>
</html>
