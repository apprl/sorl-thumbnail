{% load i18n l10n apparel_extras compressed %}
{% load static from staticfiles %}
<!doctype html>
<html lang="{{ request.LANGUAGE_CODE }}">
<head{% block head-data %}{% endblock head-data %}>
    <title>{% block full-title %}{% block extra-title %}{% endblock %}Apprl - Social Shopping{% endblock %}</title>
    <meta charset="utf-8" />
    <meta name="description" content="{% block meta_description %}{% trans "Follow your favourite brands, bloggers & friends to discover fashion you love." %}{% endblock %}">
    <link rel="stylesheet" href="{% static "styles/screen.css" %}" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="{% static "styles/print.css" %}" type="text/css" media="print">
    <link rel="shortcut icon" href="{% static "images/favicon.ico" %}">
    <link href='http://fonts.googleapis.com/css?family=Lato:400|IM+Fell+Great+Primer:400italic' rel='stylesheet' type='text/css'>
    {% block extra-styles %}
    {% endblock extra-styles %}
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script type="text/javascript">
        var hasLiked = {% if user.is_authenticated and user.get_profile.has_liked %}true{% else %}false{% endif %};
        var dialog_like_product = '{% url dialog-like-product %}';
        var dialog_like_look = '{% url dialog-like-look %}';
        var product_popup_url = '{% url product-popup %}';
        var browse_url = '{% gender_url APPAREL_GENDER 'shop' %}';
        var isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
        var share_settings = {
            'like_product': {% if user.is_authenticated and user.get_profile.fb_share_like_product %}true{% else %}false{% endif %},
            'like_look': {% if user.is_authenticated and user.get_profile.fb_share_like_look %}true{% else %}false{% endif %},
            'follow_profile': {% if user.is_authenticated and user.get_profile.fb_share_follow_profile %}true{% else %}false{% endif %},
            'create_look': {% if user.is_authenticated and user.get_profile.fb_share_create_look %}true{% else %}false{% endif %}
        };
        var selected_gender = '{{Â APPAREL_GENDER }}';
        var facebook_scope = '{{ FACEBOOK_SCOPE }}';

        window.fbAsyncInit = function() {
            FB.init({appId: {{ FACEBOOK_APP_ID }}, status: true, cookie: true, xfbml: true, channelUrl: '//{{ CURRENT_DOMAIN }}/channel.html'});
            FB.getLoginStatus(function(response) {
                if(!response.authResponse) {
                    jQuery('#ar-facepile').html('').addClass('ar-facepile');
                } else {
                    {% block facebook_code %}{% endblock %}
                }
            });
        }
    </script>
    <script type="text/javascript" src="{% url django.views.i18n.javascript_catalog %}"></script>
    {% compressed_js 'jquery' %}
    {% compressed_js 'apparel' %}
    <script type="text/javascript">
        window.login_function = function(callback) {
            _gaq.push(['_trackEvent', 'Membership', 'Signup', 'Header']);

            FB.login(function(response) {
                if(response.authResponse) {
                    data = {uid: response.authResponse.userID,
                            access_token: response.authResponse.accessToken};
                    $.post('/facebook/login', data, function(response) {
                        callback();
                    });
                }
            }, {scope: facebook_scope});
        };

        function facebookConnect(form){
            var label = '';
            if(form.parents('#footer').length) {
                label = 'Footer';
            } else if(form.parents('#header').length) {
                label = 'Header';
            } else if(form.parents('#panel').length) {
                label = 'Socialize';
            } else if(form.parents('.dialog').length) {
                label = 'Dialog';
            } else {
                label = form.parent().attr('class') || 'Unknown';
            }

            // Track facebook connect clicks to GA
            _gaq.push(['_trackEvent', 'Membership', 'Signup', label]);

            function handleResponse(response){
                if (response.authResponse) {
                    jQuery('input[name="access_token"]', form).val(response.authResponse.accessToken);
                    jQuery('input[name="uid"]', form).val(response.authResponse.userID);
                    form.submit();
                }
            }
            FB.login(handleResponse, {scope: '{{ FACEBOOK_SCOPE }}'});
        };

        jQuery(document).ready(function() {
            // FIXME: quick solution to not have to send the form to validate
            jQuery('.create-look-dialog form').live('submit', function(e) {
                if(!jQuery(this).find('#id_title').val()) {
                    if(!jQuery(this).find('.errorlist').length) {
                        var error_list = jQuery('<ul class="errorlist">').append(jQuery('<li>').text('{% trans "You have to name your look before your create it." %}'));
                        jQuery(this).find('#id_title').after(error_list);
                    }
                    return false;
                }
            });

            jQuery('.ar_welcome').click(function() {
                jQuery('#panel').slideToggle('slow');
                $(this).toggleClass("active");
                var date = new Date();
                date.setTime(date.getTime()+(10000*24*60*60*1000));
                document.cookie = "ar_welcome=1; expires="+date.toUTCString()+"; path=/";
            });

            jQuery('#nav-user .btn-facebook').on('click', function() {
                login_function(function() { window.location.reload(false); });
                return false;
            });
        });
    </script>
    {% block 'extra-scripts' %}
    {% endblock 'extra-scripts' %}
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', '{{ GOOGLE_ANALYTICS_ACCOUNT }}']);
        _gaq.push(['_setDomainName', '{{ GOOGLE_ANALYTICS_DOMAIN }}']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>
</head>
<body class="{% block body-classes %}{% endblock %}">

<div id="outer">
    {% block header %}
    <div id="header">
        <div id="inner-header">

            {% include 'apparel/shared_header.html' %}

            <form action="/apparel/search" method="get" onSubmit="return false" id="search" autocomplete="off">
                <input type="text" name="s" placeholder="{% trans "I'm looking for..." %}" />
                <a href="{{ request.url }}" id="cancel-search">{% trans "Cancel" %}</a>
            </form>

            <ul id="nav-global">
                <li class="gender subnav-gray-handle">
                    <a href="#">{% if APPAREL_GENDER == 'M' %}{% trans "Men" %}{% else %}{% trans "Women" %}{% endif %}</a>
                    <form action="{% url change-gender %}" method="post" class="select-gender">
                        {% csrf_token %}
                        <ul class="subnav-gray" id="subnav-gender">
                            <li class="first"><button name="gender" value="W">{% trans "Women" %}</button></li>
                            <li class="last"><button name="gender" value="M">{% trans "Men" %}</button></li>
                        </ul>
                    </form>
                </li>
                <li class="language subnav-gray-handle">
                    {% for language in SHORT_LANGUAGES %}
                    {% if language.0 == LANGUAGE_CODE %}
                    <a class="current language" href="{% url django.views.i18n.set_language %}">{% trans language.1 %}</a>
                    {% endif %}
                    {% endfor %}
                    <form action="{% url apparel.views.apparel_set_language %}" method="post" class="select-language">
                        {% csrf_token %}
                        <ul class="subnav-gray" id="subnav-language">
                        {% for language in LANGUAGES %}
                            <li class="{% if forloop.first %}first{% endif %}{% if forloop.last %}last{% endif %}">
                                {% if language.0 == LANGUAGE_CODE %}
                                <button class="disabled" name="language" value="{{ language.0 }}" type="submit">{% trans language.1 %}</button>
                                {% else %}
                                <button name="language" value="{{ language.0 }}" type="submit">{% trans language.1 %}</button>
                                {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    </form>
                </li>
            </ul>
        </div>
    </div>

    <div id="search-result">
        <div id="inner-search-result">
            <div class="wide result-container">
                <h2 class="search-result-products">{% trans "Matching products" %}</h2>
                <div class="product-list"><ul id="search-result-products" class="list"></ul></div>
                <div class="search-link"><a class="search-result-products btn btn-block btn-upper" href="#">{% trans "Show all products" %}</a></div>
            </div>
            <div class="result-container">
                <h2 class="search-result-looks">{% trans "Matching looks" %}</h2>
                <ul id="search-result-looks" class="looks"></ul>
                <div class="search-link"><a class="search-result-looks btn btn-block btn-upper" href="#">{% trans "Show all looks" %}</a></div>
            </div>
            <div class="last result-container">
                <h2 class="search-result-manufacturers">{% trans "Matching brands" %}</h2>
                <ul id="search-result-manufacturers"></ul>
                <div class="search-link"><a class="search-result-manufacturers btn btn-block btn-upper" href="#">{% trans "Show all manufacturers" %}</a></div>

                <h2 class="search-result-profiles">{% trans "Matching profiles" %}</h2>
                <ul id="search-result-profiles"></ul>
            </div>
            <div id="search-result-clear" class="clear"></div>
        </div>
    </div>
    {% endblock header %}

    <div id="container">

        {% url public_feed-men as public_feed_m %}
        {% url public_feed-women as public_feed_w %}
        {% url user_feed as user_feed %}
        {% if not user.is_authenticated and not request.COOKIES.ar_welcome %}
        {% if request.path == public_feed_m or request.path == public_feed_w or request.path == user_feed %}
        <div id="panel">
            <div id="panelwrap">
                <span class="row-span">
                    <h3 class="rowrubbe">{% trans "Welcome to Social Shopping!" %}</h3>
                    <p class="p-row">{% trans "Become a member to:" %}</p>
                    <ul>
                        <li>{% trans "Get sale alerts on your favourite items" %}</li>
                        <li>{% trans "Follow your friends, bloggers & brands" %}</li>
                        <li>{% trans "Create & share looks on your blog" %}</li>
                    </ul>
                </span>
                <a class="btn-slide ar_welcome" href="#"></a>
                <div id="login-fb">
                    <p class="lifc">{% blocktrans %}Life is <em>more fun</em> connected{% endblocktrans %}</p>
                    {% apparel_facebook_button "facebook-hide.png" %}
                    <a href="{% url dialog-why-facebook %}" class="open-dialog dialog-why-facebook">{% trans "Why Facebook?" %}</a>
                </div>
                <div id="ar-facepile" class="bild">
                    <div class="fb-facepile" data-max-rows="2" data-width="281" data-app-id="{{Â FACEBOOK_APP_ID }}"></div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <div id="inner-container">
            {% block body-header %}{% endblock %}
            {% block body %}{% endblock %}
        </div>
    </div>

    <div id="footer">
        <div id="inner-footer">
            <ul class="copyright">
                <li><h3>Apprl Fashion AB</h3></li>
                <li>Birger Jarlsgatan 18A</li>
                <li>114 34 Stockholm</li>
                <li>{% trans "Sweden" %}</li>
            </ul>
            <ul>
                <li><h3>{% trans "Shop" %}</h3></li>
                <li><a class="women" href="{% gender_url 'W' 'shop' %}">{% trans "Women" %}</a></li>
                <li><a class="men" href="{% gender_url 'M' 'shop' %}">{% trans "Men" %}</a></li>
                <li><a href="{% gender_url APPAREL_GENDER 'look-list' %}">{% trans "Looks" %}</a></li>
                <li><a href="{% gender_url APPAREL_GENDER 'brand-list' %}">{% trans "Brands" %}</a></li>
            </ul>
            <ul>
                <li><h3>{% trans "Social" %}</h3></li>
                {% if not user.is_authenticated %}
                <li class="facebook">{% apparel_facebook_button "facebook-footer.png" %}</li>
                {% endif %}
                <li><a href="{% url user-list %}">{% trans "Members" %}</a></li>
                {% if user.is_authenticated %}
                <li><a class="facebook-invite" href="#invite">{% trans "+ Invite friends" %}</a></li>
                {% endif %}
                <li><a href="{% url look-create %}">{% trans "+ Create look" %}</a>
            </ul>
            <ul>
                <li><h3>{% trans "Follow us" %}</h3></li>
                <li><a target="_blank" href="http://www.facebook.com/apprl">{% trans "Facebook" %}</a></li>
                <li><a target="_blank" href="{% url newsletter-redirect %}">{% trans "E-mail newsletter" %}</a></li>
            </ul>
            <ul>
                <li><h3>{% trans "Apprl" %}</h3></li>
                <li><a href="{% url about %}">{% trans "About" %}</a></li>
                <li><a href="mailto:info@apprl.com">{% trans "Contact" %}</a></li>
                <li><a href="{% url django.contrib.flatpages.views.flatpage url='about/terms-of-use/' %}">{% trans "Privacy & Terms" %}</a></li>
                <li><a href="{% url django.contrib.flatpages.views.flatpage url='about/cookies/' %}">{% trans "Cookies" %}</a></li>
            </ul>
            <div class="fb-like footer-like" data-href="https://facebook.com/apprl/" data-send="false" data-width="240" data-show-faces="false"></div>
        </div>
    </div>
</div>

<a class="feedback" href="mailto:feedback@apprl.com?subject={% trans "Hi Apprl! I have a question / idea / complaint / complement" %}">
    <img src="{% static "images/feedback-button.png" %}">
</a>

<script type="text/javascript" src="{% static "js/money.min.js" %}"></script>
<script type="text/javascript">
  fx.base = 'SEK';
  fx.rates = {
    {% for currency, rate in currency_rates.items %}
    '{{ currency }}': {{ rate|unlocalize }},
    {% endfor %}
    'SEK': 1
  };
  var current_currency = '{{ CURRENCY }}';
  function formatNumber(num) {
    var array = parseInt(num, 10).toFixed().split('');
    var index = -3;
    while (array.length + index > 0) {
      array.splice(index, 0, ' ');
      index -= 4;
    }
    return array.join('');
  };
  function currencyConversion(elements) {
    elements.each(function(index, element) {
      var $element = jQuery(element);
      var data = $element.data();
      var converted_price = Math.round(fx.convert(data.price, {from: data.currency, to: current_currency}));
      $element.text(formatNumber(converted_price) + ' ' + current_currency);
  });
}
</script>

<div id="fb-root"></div>
<script type="text/javascript">
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/sv_SE/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));
</script>

{% for template_name,template_string in templates.items %}
    <script type="text/html" id="{{ template_name }}_template">
        {{ template_string|safe }}
    </script>
{% endfor %}

<script type="text/html" id="error_dialog_template">
    <div class="dialog-container {% block dialog_class %}{% endblock %}">
        <h1>${ header }</h1>
        <div class="bodycopy content">
            {% templatetag openvariable %}each(i, message) messages{% templatetag closevariable %}
            <p>${ message }</p>
            {% templatetag openvariable %}/each{% templatetag closevariable %}
        </div>
        <div class="dialog-footer">
            <button class="no">{% trans "No" %}</button>
            <button class="yes">{% trans "Yes" %}</button>
        </div>
    </div>
</script>

{% include 'mouseflow.html' %}

{% block body-scripts %}{% endblock body-scripts %}

</body>
</html>
