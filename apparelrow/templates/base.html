{% load i18n apparel_extras django_static %}
<!doctype html>
<html lang="{{ request.LANGUAGE_CODE }}">
<head{% block head-data %}{% endblock head-data %}>
    {% with user.get_profile.get_updates_last_visit as updates %}
    <title>{% if updates %}({{ updates }}) {% endif %}{% block extra-title %}{% endblock %}Apprl</title>
    {% endwith %}
    <meta charset="utf-8" />
    <link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/smoothness/jquery-ui.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ MEDIA_URL }}{% staticfile "styles/screen.css" %}" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="{{ MEDIA_URL }}{% staticfile "styles/print.css" %}" type="text/css" media="print">
    <link rel="shortcut icon" href="{{ MEDIA_URL }}{% staticfile "images/favicon.ico" %}">
    {% block extra-styles %}
    {% endblock extra-styles %}
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js"></script>
    <script type="text/javascript">
        var hasLiked = {% if user.is_authenticated and user.get_profile.has_liked %}true{% else %}false{% endif %};
        var dialog_like_product = '{% url dialog-like-product %}';
        var dialog_like_look = '{% url dialog-like-look %}';
        var product_popup_url = '{% url product-popup %}';
        var browse_url = '{% gender_url APPAREL_GENDER 'shop' %}';
        var isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
        var isFirstTimeVisit = {% if user.is_authenticated and user.get_profile.first_visit %}true{% else %}false{% endif %};
        var share_settings = {
            'like_product': {% if user.is_authenticated and user.get_profile.fb_share_like_product %}true{% else %}false{% endif %},
            'like_look': {% if user.is_authenticated and user.get_profile.fb_share_like_look %}true{% else %}false{% endif %},
            'follow_profile': {% if user.is_authenticated and user.get_profile.fb_share_follow_profile %}true{% else %}false{% endif %},
            'create_look': {% if user.is_authenticated and user.get_profile.fb_share_create_look %}true{% else %}false{% endif %}
        };

        window.fbAsyncInit = function() {
            FB.init({appId: {{ FACEBOOK_APP_ID }}, status: true, cookie: true, xfbml: true, channelUrl: '//{{ CURRENT_DOMAIN }}{{ MEDIA_URL }}channel.html'});
            {% block facebook_code %}{% endblock %}
            FB.getLoginStatus(function(response) {
                if(!response.authResponse) {
                    jQuery('#ar-facepile').html('').addClass('ar-facepile');
                }
            });
        }
    </script>
    <script type="text/javascript" src="{% url django.views.i18n.javascript_catalog %}"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}{% staticfile "js/compiled/jquery.js" %}"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}{% staticfile "js/apparel.js" %}"></script>
    <script type="text/javascript">
         function facebookConnect(form){
            var label = '';
            if(form.parents('#footer').length) {
                label = 'Footer';
            } else if(form.parents('#header').length) {
                label = 'Header';
            } else if(form.parents('#panel').length) {
                label = 'Socialize';
            } else if(form.parents('.dialog').length) {
                label = 'Dialog';
            } else {
                label = form.parent().attr('class') || 'Unknown';
            }

            // Track facebook connect clicks to GA
            _gaq.push(['_trackEvent', 'Membership', 'Signup', label]);

            function handleResponse(response){
                if (response.authResponse) {
                    jQuery('input[name="access_token"]', form).val(response.authResponse.accessToken);
                    jQuery('input[name="uid"]', form).val(response.authResponse.userID);
                    form.submit();
                }
            }
            FB.login(handleResponse, {scope: '{{ FACEBOOK_SCOPE }}'});
        };

        jQuery(document).ready(function() {
            jQuery('.about-beta-popup').click(function(event) {
                create_html_dialog('{% url dialog-about-apparelrow %}');
                event.preventDefault();
            });

            jQuery('.about-cookies-popup').click(function(event) {
                create_html_dialog('{% url dialog-about-cookies %}');
                event.preventDefault();
            });

            // FIXME: quick solution to not have to send the form to validate
            jQuery('.create-look-dialog form').live('submit', function(e) {
                if(!jQuery(this).find('#id_title').val()) {
                    if(!jQuery(this).find('.errorlist').length) {
                        var error_list = jQuery('<ul class="errorlist">').append(jQuery('<li>').text('{% trans "You have to name your look before your create it." %}'));
                        jQuery(this).find('#id_title').after(error_list);
                    }
                    return false;
                }
            });

            jQuery('.ar_welcome').click(function() {
                jQuery('#panel').slideToggle('slow');
                $(this).toggleClass("active");
                var date = new Date();
                date.setTime(date.getTime()+(10000*24*60*60*1000));
                document.cookie = "ar_welcome=1; expires="+date.toUTCString()+"; path=/";
            });
        });
    </script>
    {% block 'extra-scripts' %}
    {% endblock 'extra-scripts' %}
</head>
<body class="{% block body-classes %}{% endblock %}">

 <div id="outer">
    <div id="header">
        <div id="inner-header">
            <a href="{% gender_url APPAREL_GENDER 'shop' %}"><h1>Apprl</h1></a>

            <form action="/apparel/search" method="get" onSubmit="return false" id="search" autocomplete="off">
                <input type="text" name="s" placeholder="{% trans 'Search for products' %}" />
                <a href="{{ request.url }}" id="cancel-search">{% trans "Cancel" %}</a>
            </form>

            <div id="nav-gender">
                <a class="left{% if APPAREL_GENDER == 'W' %} selected{% endif %}" href="{% change_gender_url request APPAREL_GENDER 'women' %}">{% trans "Women" %}</a>
                <a class="right{% if APPAREL_GENDER == 'M' %} selected{% endif %}" href="{% change_gender_url request APPAREL_GENDER 'men' %}">{% trans "Men" %}</a>
            </div>

            <ul id="nav-main">
                <li><a class="{% selected_url request "/" %}" href="{% gender_url APPAREL_GENDER 'shop' %}">{% trans "Shop" %}</a></li>
                <li><a class="{% selected_url request "/brands" %}" href="{% gender_url APPAREL_GENDER 'brand-list' %}">{% trans "Brands" %}</a></li>
                <li><a class="{% selected_url request "/looks" %}" href="{% gender_url APPAREL_GENDER 'look-list' %}">{% trans "Looks" %}</a></li>
                <li><a class="{% selected_url request "/users" %}" href="{% url user-list-popular %}">{% trans "Members" %}</a></li>
            </ul>

            <ul id="nav-user">
                {% if not user.is_authenticated %}
                <li class="facebook">{% apparel_facebook_button %}</li>
                {% endif %}
                <li class="language">
                    {% include 'apparel/fragments/set_language.html' with csrf_token=csrf_token LANGUAGES=LANGUAGES SHORT_LANGUAGES=SHORT_LANGUAGES LANGUAGE_CODE=LANGUAGE_CODE only %}
                </li>
            </ul>
        </div>
    </div>

    <div id="search-result">
        <div id="inner-search-result">
            <div class="wide result-container">
                <h2 class="search-result-products">{% trans "Matching products" %}</h2>
                <div class="product-list"><ul id="search-result-products" class="list"></ul></div>
                <div class="search-link"><a class="search-result-products" href="#">{% trans "Show all products" %}</a></div>
            </div>
            <div class="result-container">
                <h2 class="search-result-looks">{% trans "Matching looks" %}</h2>
                <ul id="search-result-looks" class="looks"></ul>
                <div class="search-link"><a class="search-result-looks" href="#">{% trans "Show all looks" %}</a></div>
            </div>
            <div class="last result-container">
                <h2 class="search-result-manufacturers">{% trans "Matching brands" %}</h2>
                <ul id="search-result-manufacturers"></ul>
                <div class="search-link"><a class="search-result-manufacturers" href="#">{% trans "Show all manufacturers" %}</a></div>
            </div>
            <div id="search-result-clear" class="clear"></div>
        </div>
    </div>

    <div id="container">

        {% if not user.is_authenticated and not request.COOKIES.ar_welcome  %}
        <div id="panel">
            <div id="panelwrap">
                <span class="row-span">
                    <h1 class="rowrubbe">{% trans "Socialize!" %}</h1>
                    <p class="p-row">{% trans "Connect your Facebook account to:" %}</p>
                    <ul>
                        <li>{% trans "Collect products you like under your profile" %}</li>
                        <li>{% trans "Follow your favourite brands, bloggers & members" %}</li>
                        <li>{% trans "See what clothes & looks your friends like" %}</li>
                    </ul>
                    <p class="p-row p-light">{% trans "You will always control what is being shared to your Facebook profile." %}</p>
                </span>
                <a class="btn-slide ar_welcome" href="#"></a>
                <div id="login-fb">
                    <p class="lifc">{% blocktrans %}Life is <em>more fun</em> connected{% endblocktrans %}</p>
                    {% apparel_facebook_button "facebook-hide.png" %}
                    <a href="{% url dialog-why-facebook %}" class="open-dialog dialog-why-facebook">{% trans "Why Facebook?" %}</a>
                </div>
                <div id="ar-facepile" class="bild">
                    <div class="fb-facepile" data-max-rows="2" data-width="281" data-app-id="{{ FACEBOOK_APP_ID }}"></div>
                </div>
            </div>
        </div>
        {% endif %}

    {% if user.is_authenticated and user.get_profile %}
        {% url apparel.views.home as home_url %}
        {% url apparel.views.look_create as look_create_url %}
        {% url profile.views.settings_notification as notification_settings_url %}
        {% url profile.views.settings_email as email_settings_url %}

        {% url profile-updates user.get_profile.slug as url_updates %}
        {% url profile-likes user.get_profile.slug as url_likes %}
        {% url profile-looks user.get_profile.slug as url_looks %}
        {% url profile-followers user.get_profile.slug as url_followers %}
        {% url profile-following user.get_profile.slug as url_following %}

        <div id="login-pane">
            <div class="holder">
                <ul>
                    <li class="profile">
                        <a class="{% if request.path == url_updates or request.path == url_likes or request.path == url_looks or request.path == url_followers or request.path == url_following %} selected{% endif %}"href="{{ url_likes }}">
                            <img src="{{ user.get_profile.avatar }}" class="avatar small">
                            {{ user.get_profile.display_name }}
                            <div class="arrow"></div>
                        </a>
                        <ul class="profile-hover-menu" style="display: none;">
                            <li class="arrow"></li>
                            <li class="first"><a href="{{ url_likes }}">{% trans "Likes" %}</a></li>
                            <li><a href="{{ url_updates }}">{% trans "Updates" %}</a></li>
                            <li><a href="{{ url_looks }}">{% trans "Looks" %}</a></li>
                            <li><a href="{{ url_followers }}">{% trans "Followers" %}</a></li>
                            <li class="last"><a href="{{ url_following }}">{% trans "Following" %}</a></li>
                        </ul>
                    </li>
                    <li class="updates">
                        <a class="{% if request.path == home_url %} selected{% endif %}" href="{{ home_url }}">
                            {% with user.get_profile.get_updates_last_visit as updates %}
                            <span>{% trans "Friends' updates" %}{% if updates %} ({{ updates }}){% endif %}</span>
                            {% endwith %}
                            <div class="arrow"></div>
                        </a>
                    </li>
                    <li class="settings">
                        <a class="{% if request.path == notification_settings_url or request.path == email_settings_url %} selected{% endif %}" href="{{ notification_settings_url }}">
                            <span>{% trans "Settings" %}</span>
                            <div class="arrow"></div>
                        </a>
                    </li>
                </ul>
                <div class="create-look">
                    <a class="open-dialog create-look" data-dialog-width="380" href="{{ look_create_url }}">{% trans "Create a look" %}</a>
                </div>
                <div class="friends-favorites">
                    <a href="{% gender_url APPAREL_GENDER 'shop' %}#f=1">{% trans "Friends' Favorites" %}</a>
                </div>
                <div class="right logout">
                    <a href="/accounts/logout/" id="logout">{% trans "Logout" %}</a>
                </div>
            </div><!-- holder -->
        </div>
    {% endif %}

        <div id="inner-container">
            {% block body %}{% endblock %}
        </div>
    </div>

    <div id="footer">
        <div id="inner-footer">
            <ul class="copyright">
                <li><h3>Apparelrow AB</h3></li>
                <li>Birger Jarlsgatan 18A</li>
                <li>114 34 Stockholm</li>
                <li>{% trans "Sweden" %}</li>
            </ul>
            <ul>
                <li><h3>{% trans "Shop" %}</h3></li>
                <li><a class="women" href="{% gender_url 'W' 'shop' %}">{% trans "Women" %}</a></li>
                <li><a class="men" href="{% gender_url 'M' 'shop' %}">{% trans "Men" %}</a></li>
            </ul>
            <ul>
                <li><h3>{% trans "Looks" %}</h3></li>
                <li><a href="{% gender_url APPAREL_GENDER 'look-list' %}">{% trans "All looks" %}</a></li>
                {% if not user.is_authenticated %}
                <li><a class="open-dialog" href="{% url apparel.views.look_create %}">{% trans "Create a look" %}</a></li>
                {% else %}
                <li><a class="open-dialog" data-dialog-width="380" href="{% url apparel.views.look_create %}">{% trans "Create a look" %}</a></li>
                {% endif %}
            </ul>
            <ul>
                <li><h3>{% trans "Social" %}</h3></li>
                <li><a href="{% url user-list %}">{% trans "All members" %}</a></li>
                {% if not user.is_authenticated %}
                <li class="facebook">{% apparel_facebook_button "facebook-footer.png" %}</li>
                {% endif %}
            </ul>
            <ul>
                <li><h3>{% trans "About Apprl" %}</h3></li>
                <li><a href="{% url about %}">{% trans "About" %}</a></li>
                <li><a target="_blank" href="http://blog.apprl.com/">{% trans "Blog" %}</a></li>
                <li><a href="mailto:info@apprl.com">{% trans "Contact" %}</a></li>
                <li><a class="about-cookies-popup" href="/">{% trans "Cookies" %}</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="fb-root"></div>
<script type="text/javascript">
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/sv_SE/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));
</script>

{% for template_name,template_string in templates.items %}
    <script type="text/html" id="{{ template_name }}_template">
        {{ template_string|safe }}
    </script>
{% endfor %}

<script type="text/html" id="error_dialog_template">
    <div class="dialog-container {% block dialog_class %}{% endblock %}">
        <h1>${ header }</h1>
        <div class="bodycopy content">
            {% templatetag openvariable %}each(i, message) messages{% templatetag closevariable %}
            <p>${ message }</p>
            {% templatetag openvariable %}/each{% templatetag closevariable %}
        </div>
        <div class="dialog-footer">
            <button class="no">{% trans "No" %}</button>
            <button class="yes">{% trans "Yes" %}</button>
        </div>
    </div>
</script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', '{{ GOOGLE_ANALYTICS_ACCOUNT }}']);
  _gaq.push(['_setDomainName', '{{ GOOGLE_ANALYTICS_DOMAIN }}']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>

