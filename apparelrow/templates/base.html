{% load i18n %}
{% load facebook_tags %}
{% load apparel_extras %}
<!doctype html>
<html lang="{{ lang }}">
<head>
    <title>{% block extra-title %}{% endblock %}Apparel Row</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="{{ MEDIA_URL }}/styles/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="{{ MEDIA_URL }}/styles/print.css" type="text/css" media="print">
    <link type="text/css" href="{{ MEDIA_URL }}/styles/smoothness/jquery-ui-1.8rc3.custom.css" rel="stylesheet" />
    {% block 'extra-styles' %}
    {% endblock 'extra-styles' %}
    
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
        google.load("jquery", "1.4.1");
        google.load("jqueryui", "1.7.2");
    </script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.autogrow.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/apparel.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.hypersubmit.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.tools.min.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/dump.js"></script>
    <script type="text/javascript" src="{{ MEDIA_URL }}/js/resig.js"></script>
    <script type="text/javascript">
        
        jQuery(document).ready(function() {
            // Make all "apparel rows" scrollables
            jQuery('.row').scrollable().end();

             jQuery('#login').click(function() {
                jQuery('#nav-main').animate({ opacity: 'toggle' }, 'fast');
                jQuery('#account-dialogue').animate({ opacity: 'toggle' }, 'fast');
                
                return false;
            });
            
            /* Toggle text field texts */
            jQuery('#account-dialogue input[type=text]').each(function() {
                if(this.name) {
                    jQuery(this).focus(function() { 
                        this.value = '';
                        jQuery(this).removeClass('default-value');
                    } );
                    
                    jQuery(this).blur(function() { 
                        if(this.value == '') {
                            this.value = this.defaultValue 
                            jQuery(this).addClass('default-value');
                        }
                    } );
                }
            });
            
            /* Toggle password box */
            jQuery('#login-password-placeholder').focus(function() {
                pwdField = jQuery('#login-password');
                jQuery(this).toggle();
                pwdField.toggle();
                pwdField.focus();
            });
            
            jQuery('#login-password').blur(function() {
                if(this.value == '') {
                    txtField = jQuery('#login-password-placeholder');
                    jQuery(this).toggle();
                    txtField.toggle();
                }
            });
            
            
            
            // Add handlers
            jQuery('#searchbox').keyup(function(e) {
                // FIXME: Ignore if modifier is used (apart from shift)
                j = jQuery(this);
                clearTimeout(j.data('tid'));
                
                switch(e.keyCode) {
                    case 0: // command+tab
                    case 9: // tab
                    case 13: // enter
                    case 17: // ctrl
                    case 18: // alt
                    case 224: // command
                        return false;
                    case 27: // escape
                        hideSearch();
                        return false;
                    
                    default:
                        j.data('tid', setTimeout(search, 1000));
                }
            });

        });
        
        
        // FIXME: Move these into namespace 
        function search() {
            var value = jQuery('#searchbox').val();
            if(value.length == 0)
                return
            
            jQuery.getJSON('{% url apparel.views.wide_search %}', {
                s: value
            }, display);
        }
        
        function hideSearch() {
            jQuery('#search-result').hide();
            jQuery('#search').removeClass('expanded');
        }

        function display(data) {
            jQuery('#search-result').fadeIn();
            jQuery('#search').addClass('expanded');
            $.each(data.result, function(result_type, result) {
                var ele = jQuery('#search-result-' + result_type);
                ele.empty();
                template.render(ele, result, jQuery.template(data.templates[result_type]),
                    function(obj) {
                        return template.getTemplateContext({
                            'product': {
                                'object': obj,
                                'properties': ['id', 'product_image', 'product_name']
                            },
                        });
                    }
                );
            });
            /*
            for( var name in data.result) {
                var elem = jQuery('#search-result-' + name);
                if(!elem)
                    continue;
                
                if(!name in adders)
                    continue;
                
                elem.empty();
                
                for(var i = 0; i < data[name].length; i++)
                    adders[name](elem, data[name][i]);
            }
            */
        }
        
        // FIXME: These could be replaced with different templates to process
        adders = {
            'products': function(elem, product) {
                elem.append('<h3>' + product.product_name + '</h3>');
                elem.append('<a href="/apparel/products/' + product.id + '">Read more</a>');
            },
            'manufacturers': function(elem, manufacturer) {
                elem.append('<h3>' + manufacturer.name + '</h3>');
                elem.append('<a href="/apparel/manufacturer/' + manufacturer.id + '">Read more</a>');            
            },
            'categories': function(elem, category) {
                elem.append('<h3>' + category.name + '</h3>');
                elem.append('<a href="/apparel/products/' + category.id + '">Read more</a>');
            }
        };  
        
                
    </script>
    {% block 'extra-scripts' %}
    {% endblock 'extra-scripts' %}
    {% facebook_js %}
    {% initialize_facebook_connect %}
</head>
<body class="{% block body-classes %}{% endblock %}">

<div id="header">
        
        <a href="/"><h1>ApparelRow</h1></a>
        
        <div id="account-dialogue">
            <!-- LOGIN FORM -->
            <form action="/accounts/login/" method="post" id="login-form">
                <!--
                <a id="login-forgot-password" href="/accounts/password/reset/">{% trans "Forgot password?" %}</a>
                <a id="login-create-account" href="/accounts/register/">{% trans "Create account" %}</a>
                -->
                <div>
                    <input type="text" name="username" class="default-value" value="{% trans "Username" %}" id="login-username" />
                    <input type="text" value="{% trans "Password" %}" class="default-value" id="login-password-placeholder" />
                    <input type="password" name="password" id="login-password" />
                    <button type="submit" name="submit" id="login-submit">{% trans "Login" %}</button>
                    {% ifequal request.path "/accounts/logout/" %}
                        <input type="hidden" name="next" value="/" />
                    {% else %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                    {% endifequal %}
                </div>
            </form>
            {# Facebook connect button #}
            {% with "/media/images/fblogo.png" as fb_connect_logo %}
                {% include "facebook/connect_button.html" %}
            {% endwith %}
        </div>
        <form action="/apparel/search" method="get" onsubmit="return false">
            <div id="search">
                <input type="text" name="s" id="searchbox" />
                <div id="search-result">
                    <div class="span-11">
                        <h2>{% trans "Products" %}</h2>
                        <div class="search-result-container" id="search-result-products">
                        </div>
                    </div>
                    <div class="span-5">
                        <h2>{% trans "Categories" %}</h2>
                        <div class="search-result-container" id="search-result-categories">
                        </div>
                    </div>
                    <div class="span-5">
                        <h2>{% trans "Manufacturers" %}</h2>
                        <div class="search-result-container" id="search-result-manufacturers">
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <ul id="nav-main">
            <li><a href="/">{% trans "Home" %}</a></li>            
        {% if user.is_authenticated %}
            <li><a href="/profile/"{% ifequal request.path "/apparel/profile/" %} class="selected"{% endifequal %}>{% trans "My Profile" %}</a></li>            
        {% else %}
            <li><a href="/accounts/login/" id="login">{% trans "Login" %}</a></li>
            <li><a href="/accounts/register/" id="login">{% trans "Sign up" %}</a></li>
        {% endif %}
        </ul>
</div>


{% if user.is_authenticated and user.get_profile %}
<div id="login-pane">
    <div class="container clearfix">
        <a href="/accounts/logout/" id="logout">{% trans "Logout" %}</a>
        <span id="logged-in-as">
            {% trans "Logged in as" %}: <strong>{{ user.get_profile.display_name }}</strong>
        </span>
        <ul id="nav-user">
        </ul>
    </div>
</div>
{% endif %}

<div id="container">
{% block body %}
{% endblock %}
</div>
{% for template_name,template_string in templates.items %}
    <script type="text/html" id="{{ template_name }}_template">
    <![CDATA[
        {{ template_string|safe }}
    ]]>
    </script>
{% endfor %}
</body>
</html>
