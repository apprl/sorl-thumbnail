{% load i18n cache %}

<div class="featured-container">
    <div class="container">
        <div class="body-header">
            <div class="body-header-col-full">
                <h1>{% trans "Spotlight" %}</h1>
                {% if in_feed %}
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true"></button>
                {% endif %}
            </div>
        </div>
        <div class="row">

        {% comment %}
            {% include 'apparel/fragments/topmodel-featured.html' %}
        {% endcomment %}
            {% for activity in featured %}
            <div class="col-featured-item">
                <div class="feed-item featured-feed-item panel" id="user-featured-{{ activity.user_id }}" data-user-id="{{ activity.user_id }}">
                    {% cache CACHE_TIMEOUT activity_featured_header activity.id LANGUAGE_CODE %}
                    <div class="panel-heading">
                        <a href="{{ activity.user.get_absolute_url }}"><img class="img-circle" src="{{ activity.user.avatar }}"></a>
                        {% if activity.verb == 'like_product' %}
                        <p>{% trans "Selected by" %} <a href="{{ activity.user.get_absolute_url }}">{{ activity.user.display_name }}</a></p>
                        {% else %}
                        <p>{% trans "Created by" %} <a href="{{ activity.user.get_absolute_url }}">{{ activity.user.display_name }}</a></p>
                        {% endif %}
                        {% include 'apparel/fragments/follow_cache.html' only %}
                    </div>
                    {% endcache %}
                    <div class="panel-body">
                        {% if activity.verb == 'like_product' %}
                        {% cache CACHE_TIMEOUT product_medium activity.object_id LANGUAGE_CODE %}
                        {% include 'apparel/fragments/product_medium.html' with object=activity.activity_object %}
                        {% endcache %}
                        {% else %}
                        {% cache CACHE_TIMEOUT look_medium_featured activity.object_id LANGUAGE_CODE %}
                        {% include 'apparel/fragments/look_medium.html' with featured=True object=activity.activity_object %}
                        {% endcache %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script type="text/javascript">
(function() {
    function follow(uids) {
        $.post('{% url 'follow-backend' %}', {uids: uids}, function(response) {
            $.each(response, function(i, obj) {
                $('#user-featured-' + obj['id'] + ' .btn-follow-placeholder').replaceWith(obj['html']);
            });
        });
    }
    {% if request.user.is_authenticated %}
    follow($('.featured-container .feed-item').map(function() { return $(this).attr('id').split('-')[2]; }).get().join(','));
    {% endif %}
    $('.featured-container .close').click(function() {
        $('.featured-container').slideUp(400);
        var date = new Date();
        date.setHours(24, 0, 0, 0);
        document.cookie = "ar_featured=1; expires="+date.toString()+"; path=/";
    });

    $('.featured-container .featured-feed-item').each(function(i, element) {
        var feed_user_id = $(element).data('user-id');
        var buy_button = $(element).find('.btn-product-buy');
        if (buy_button.length > 0) {
            var buy_url = buy_button.attr('href');
            if(typeof buy_url != 'undefined') {
                buy_url = buy_url.replace('Shop/0/', 'Feed/' + feed_user_id + '/');
                $('.hover .btn-product-buy', element).attr('href', buy_url);
            }
        }
    });
})()
</script>
