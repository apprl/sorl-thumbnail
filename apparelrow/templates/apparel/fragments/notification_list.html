{% load thumbnail apparel_extras staticfiles %}
{% load tz %}

<li class="hidden-xs dropdown">
    <a class="dropdown-toggle dropdown-notifications" data-toggle="dropdown" data-user="{{ request.user.id }}" href="#">
        <?xml version="1.0" encoding="utf-8" standalone="no"?>
        <svg width="9px" height="16px" viewBox="0 0 9 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g stroke="none" stroke-width="1" fill="none">
                <g fill="#ffffff">
                    <path d="M5.56425,5.4157037 L7.61271429,0.231407407 L1.854,0.231407407 L0.297321429,7.78607407 L3.17667857,7.78607407 L1.25228571,15.7685926 L8.70235714,5.4157037 L5.56425,5.4157037 L5.56425,5.4157037 Z"></path>
                </g>
            </g>
        </svg>
        {% if request.user.unread_count > 0 %}<span id="unread_count" class="unread_count badge">{{ request.user.unread_count }}</span>{% endif %}
    </a>

    <ul class="dropdown-menu notifications-menu" role="menu">
        {% localtime on %}
        {% for event in request.user.notifications %}
            <li class="notice">
                {% if event.type == "LIKELOOK" %}
                    <a href="{{ event.look.get_absolute_url }}">
                        <figure>
                            <img class="img-circle" src="{{ event.actor.avatar_small }}" alt="{{ event.actor }}" title="{{ event.actor }}" width="32" height="32" />
                        </figure>
                        <p class="message"><strong>{{ event.actor }}</strong> liked your look <strong>{{ event.look.title }}</strong></p>
                    </a>
                {% elif event.type == "FB" %}
                    <a href="{{ event.actor.url_likes }}">
                        <figure">
                            <img class="img-circle" src="{{ event.actor.avatar_small }}" alt="{{ event.actor }}" title="{{ event.actor }}" width="32" height="32" />
                        </figure>
                        <p class="message">Your Facebook friend <strong>{{ event.actor }}</strong> is now on APPRL!</p>
                     </a>
                {% elif event.type == "SALE" %}
                    <a href="{% url 'product-detail' slug=event.product.slug %}">
                        <figure>
                            {% thumbnail event.product.product_image "32" crop="noop" as im %}
                            <img class="img-circle" src="{{ im.url }}" alt="{{ event.actor }}" title="{{ event.actor }}" width="32" height="32" />
                            {% endthumbnail %}
                        </figure>
                        <p class="message"><strong>{{ event.product }}</strong>is on sale!</p>
                    </a>
                {% elif event.type == "FOLLOW" %}
                    <a href="{{ event.actor.url_likes }}">
                        <figure>
                            <img class="img-circle"  src="{{ event.actor.avatar_small }}" alt="{{ event.actor }}" title="{{ event.actor }}" width="32" height="32" />
                        </figure>
                        <p class="message"><strong>{{ event.actor }}</strong> started following you!</p>
                     </a>
                {% endif %}
                    <span>{{ event.created|since }}</span>
            </li>
        {% empty %}
           <li><p class="no-results">You have no new notifications.</p></li>
        {% endfor %}
        {% if request.user.notifications %}
           <li><a href="{% url 'notifications-page' %}">See all</a></li>
        {% endif %}
        {% endlocaltime %}
    </ul>
</li>

<script>
    $(document).ready(function(){
        $(".notification-dropdown").click(function() {
            $('.ncp-time').each(function(i, obj) {
                var text = obj.textContent;
                text = text.replace('minutes', 'min');
                text = text.replace('minute', 'min');
                text = text.replace(' ago', '');
                text = text.replace('hour', 'hr');
                text = text.replace('hours', 'hrs');
                obj.textContent = text;
            });
            var user_id = $(this).data("user");
            var unread_count = document.getElementById("unread_count");
            document.getElementById("unread_count").style.display = 'none';
            $.ajax({
                type: "post",
                url: "{% url 'notifications-seen' %}",
                data: { user_id: user_id},
                success: function (response) {
                    var json = jQuery.parseJSON(response);
                }
            });
        });

        $(document).on( 'click', function(event) {
            if (!$(event.target).closest( '.ncp-notifications' ).length) {
                if ( $( '.ncp-notifications' ).is( ':visible') ) {
                    $( '.notification-dropdown' ).toggleClass( 'active' );
                }
            }
        });
    });
</script>