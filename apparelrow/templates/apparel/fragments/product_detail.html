{% load i18n comments apparel_extras buy_extras cache thumbnail %}
{% if object and object.product_image %}
{% cache CACHE_TIMEOUT product_detail_fragment object.id LANGUAGE_CODE %}
<div class="product-info" itemprop="offerDetails" itemscope itemtype="http://data-vocabulary.org/Offer">
    <!-- {{ object.popularity }} -->

    <div class="breadcrumb">
        <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
            <a itemprop="url" href="{% gender_url object.gender 'shop' %}">
                <span itemprop="title">{% trans object.get_gender_display %}</span>
            </a> \
        </span>
        {% for category in object.categories %}
            {% if forloop.first %}
            <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a itemprop="url" href="{% gender_url object.gender 'shop' %}#category={{ category.id }}">
                    <span itemprop="title">{{ category }}</span>
                </a>
            </span>
            {% else %}
            \ <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a itemprop="url" href="{% gender_url object.gender 'shop' %}#category={{ category.id }}">
                    <span itemprop="title">{{ category }}</span>
                </a>
            </span>
            {% endif %}
        {% endfor %}
        \ <span itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
            <a itemprop="url" href="{% gender_url object.gender 'shop' %}#manufacturer={{ object.manufacturer.id }}">
                <span itemprop="name">{{ object.manufacturer }}</span>
            </a>
        </span>
    </div>

    {% regroup object.options.all by option_type as option_list %}
    <!-- FIXME: Style this properly. See ticket #300
    <ul class="product-options">
    {% for option in option_list %}
        <li>{{ option.grouper }}
        <ul class="option-{{ option.grouper|slugify }} clearfix">
            {% for item in option.list %}
            <li class="{{ item.value|slugify }}">{{ item.value }}</li>
            {% endfor %}
        </ul>
        </li>
    {% endfor %}
    </ul>
    -->
    <p class="bodycopy description" itemprop="description">{{ object.description }}</p>
{% endcache %}
    <p class="bodycopy vendors" itemprop="seller" itemscope itemtype="http://data-vocabulary.org/Organization">
      {% if object.default_vendor %}
        {% if object.default_vendor.availability == 0 %}
        <a target="_blank" href="{{ object.default_vendor.vendor.homepage }}">{% trans "Was available at " %}<span itemprop="name">{{ object.default_vendor.vendor }}</span> &raquo;</a>
        {% else %}
        <a target="_blank" class="btn-buy" href="{% buy_url object.id object.default_vendor referral_sid 'Product' %}" data-sid="{% get_sid referral_sid 'Product' %}" data-slug="{{ object.slug }}" data-vendor="{{ object.default_vendor.vendor }}" data-price="{{ object.default_vendor.lowest_price_in_sek|floatformat:0 }}">{% trans "Available at " %}<span itemprop="name">{{ object.default_vendor.vendor }}</span> &raquo;</a>
        {% endif %}
      {% endif %}
    </p>
    <div class="product-vendors group">
        {% with object.default_vendor as vendorproduct %}
        {% if vendorproduct %}
            <meta itemprop="condition" content="new" />
            <meta itemprop="currency" content="{{ vendorproduct.locale_currency }}" />
            <meta itemprop="price" content="{{ object.default_vendor_price|floatformat:0|apprl_intcomma }}" />

            <div class="product-vendor">
                <div class="computed-price">
                    {% if vendorproduct.locale_discount_price %}
                    <span class="discount-price price">{{ vendorproduct.locale_discount_price|floatformat:0|apprl_intcomma }}</span>
                    {% endif %}
                    <span class="price"{% if vendorproduct.locale_discount_price %} style="text-decoration:line-through;"{% endif %}>{{ vendorproduct.locale_price|floatformat:0|apprl_intcomma }}</span>
                    <span class="currency">{{ vendorproduct.locale_currency }}</span>
                </div>
                {% if vendorproduct.locale_currency != vendorproduct.original_currency %}
                <div class="original-price">
                    {% if vendorproduct.locale_discount_price %}
                    <span class="discount-price price">{{ vendorproduct.original_discount_price|floatformat:0|apprl_intcomma }}</span>
                    {% endif %}
                    <span class="price"{% if vendorproduct.locale_discount_price %} style="text-decoration:line-through;"{% endif %}>{{ vendorproduct.original_price|floatformat:0|apprl_intcomma }}</span>
                    <span class="currency">{{ vendorproduct.original_currency }}</span>
                </div>
                {% endif %}
            </div>
            {% if vendorproduct.availability == 0 %}
            <span itemprop="availability" content="out_of_stock" class="btn btn-upper btn-disabled btn-sold-out">{% trans "Sold out" %}</span>
            {% else %}
            <a itemprop="availability" content="in_stock" href="{% buy_url object.id vendorproduct referral_sid 'Product' %}" target="_blank" class="btn btn-upper btn-positive btn-buy" data-sid="{% get_sid referral_sid 'Product' %}" data-slug="{{ object.slug }}" data-vendor="{{ vendorproduct.vendor }}" data-price="{{ vendorproduct.lowest_price_in_sek|floatformat:0 }}">{% trans "Buy" %}</a>
            {% endif %}
        {% else %}
            <span class="btn btn-upper btn-disabled btn-sold-out">{% trans "Sold out" %}</span>
            <div class="product-vendor">
                <span class="price"></span><span class="currency"></span>
            </div>
        {% endif %}
        {% endwith %}
    </div>

    {% if object.original_currency_list %}
    <div class="product-original-currency">
        {% blocktrans with object.original_currency_list|join:", " as original_currency %}The item is sold in {{ original_currency }} and the conversion to {{ CURRENCY }} is approximate.{% endblocktrans %}
    </div>
    {% endif %}

    {% include 'apparel/fragments/share.html' %}
    {% if request.user.is_partner and object.default_vendor and object.default_vendor.availability != 0 %}
    <div class="short-link-container">
        {% if product_short_link %}
        {% include 'apparel/fragments/product_short_link.html' with product_short_link=product_short_link only %}
        {% else %}
        <a href="{% url 'product-generate-short-link' object.slug %}" class="btn btn-upper btn-short-link">{% trans "Get product link" %}</a>
        {% endif %}
    </div>
    {% endif %}

    <div class="product-looks">
        <h2 id="looks">
            {% blocktrans count looks_with_product_count as counter %}<span class="count">{{ counter }}</span> look with this product{% plural %}<span class="count">{{ counter }}</span> looks with this product{% endblocktrans %}
        </h2>
        <ul class="looks group">
        {% for look in looks_with_product %}
            {% cycle '<li>' '<li class="last">' %}
                {% cache CACHE_TIMEOUT look_small_like_product look.id LANGUAGE_CODE %}
                <a title="{{ look.title }}" href="{% if looks_with_product|length == 1 %}{% url 'look-detail' slug=look.slug %}{% else %}{% url 'product-look-list' contains=object.slug %}{% endif %}">
                    <div class="look">
                    {% thumbnail look.static_image "93x69" crop="noop" format="PNG" transparent=True as im %}
                        <img id="look-{{ look.id }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" />
                    {% endthumbnail %}
                    </div>
                    <span class="button">{% include 'apparel/fragments/likes_no_text.html' %}</span>
                </a>
            {% endcache %}
            </li>
        {% endfor %}
        </ul>
        <a class="underline" href="{% url 'look-create-like' slug=object.slug %}">{% trans "Create your look with " %}{{ object }} »</a>
        {% if looks_with_product_count > 2 %}
        <a href="{% url 'product-look-list' contains=object.slug %}" class="btn btn-block btn-upper">{% trans "See all looks" %}</a>
        {% endif %}
    </div>

</div>
{% endif %}

