{% load i18n %}
{% load humanize %}
{% load comments %}
{% load apparel_extras %}
{% load cache %}
{% if object and object.product_image %}
{% cache CACHE_TIMEOUT product_detail_fragment object.id LANGUAGE_CODE %}
<div class="product-info">
    <!-- {{ object.popularity }} -->
    <div class="breadcrumb">
    <a href="{% gender_url object.gender 'shop' %}">{% trans object.get_gender_display %}</a> \
    {% for category in object.categories %}
    {% if forloop.first %}
    <a href="{% gender_url object.gender 'shop' %}#category={{ category.id }}">{{ category }}</a>
    {% else %}
    \ <a href="{% gender_url object.gender 'shop' %}#category={{ category.id }}">{{ category }}</a>
    {% endif %}
    {% endfor %}
    {% with object.categories|last as last_category %}
    \ <a href="{% gender_url object.gender 'shop' %}#category={{ last_category.id }}&manufacturer={{ object.manufacturer.id }}">{{ object.manufacturer }}</a>
    {% endwith %}
    </div>
    <h1><a href="{{ object.manufacturer.profile.get_absolute_url }}">{{ object.manufacturer }}</a></h1>
    {% if object.product_name %}<h2>{{ object.product_name }}</h2>{% endif %}
    {% regroup object.options.all by option_type as option_list %}
    <!-- FIXME: Style this properly. See ticket #300 
    <ul class="product-options">
    {% for option in option_list %}
        <li>{{ option.grouper }}
        <ul class="option-{{ option.grouper|slugify }} clearfix">
            {% for item in option.list %}
            <li class="{{ item.value|slugify }}">{{ item.value }}</li>
            {% endfor %}
        </ul>
        </li>
    {% endfor %}
    </ul>
    -->
    <p class="bodycopy description">{{ object.description }}</p>
    <p class="bodycopy vendors">
      {% if object.default_vendor %}
        {% if object.default_vendor.availability == 0 %}
        <a target="_blank" href="{{ object.default_vendor.vendor.homepage }}">{% trans "Was available at " %}{{ object.default_vendor.vendor }} &raquo;</a>
        {% else %}
        <a target="_blank" href="{% url apparelrow.statistics.views.product_click_count %}?i={{ object.id }}&u={{ object.default_vendor.buy_url|urlencode }}" data-slug="{{ object.slug }}" data-vendor="{{ object.default_vendor.vendor }}" data-price="{{ object.default_vendor.price|floatformat:0 }}">{% trans "Available at " %}{{ object.default_vendor.vendor }} &raquo;</a>
        {% endif %}
      {% endif %}
    </p>
    <div class="product-vendors">
        {% with object.vendorproduct.all|dictsort:'price' as vendorproducts %}
        {% for vendorproduct in vendorproducts %}
            {% if forloop.first %}
                {% if vendorproduct.availability == 0 %}
                <span class="sold-out{% if vendorproduct.currency != vendorproduct.original_currency %} higher{% endif %}">{% trans "Sold out" %}</span>
                {% else %}
                <a href="{% url apparelrow.statistics.views.product_click_count %}?i={{ object.id }}&u={{ vendorproduct.buy_url|urlencode }}" target="_blank" class="buy-now{% if vendorproduct.currency != vendorproduct.original_currency %} higher{% endif %}" data-slug="{{ object.slug }}" data-vendor="{{ vendorproduct.vendor }}" data-price="{{ vendorproduct.price|floatformat:0 }}">{% trans "Buy" %}</a>
                {% endif %}
            {% endif %}
            <div class="product-vendor">
                <div class="computed-price">
                    {% if vendorproduct.discount_price %}
                    <span class="discount-price price">{{ vendorproduct.discount_price|floatformat:0 }}</span>
                    {% endif %}
                    <span class="price"{% if vendorproduct.discount_price %} style="text-decoration:line-through;"{% endif %}>{{ vendorproduct.price|floatformat:0 }}</span>
                    <span class="currency">{{ vendorproduct.currency }}</span>
                </div>
                {% if vendorproduct.currency != vendorproduct.original_currency %}
                <div class="original-price">
                    {% if vendorproduct.discount_price %}
                    <span class="discount-price price">{{ vendorproduct.original_discount_price|floatformat:0 }}</span>
                    {% endif %}
                    <span class="price"{% if vendorproduct.discount_price %} style="text-decoration:line-through;"{% endif %}>{{ vendorproduct.original_price|floatformat:0 }}</span>
                    <span class="currency">{{ vendorproduct.original_currency }}</span>
                </div>
                {% endif %}
            </div>
        {% empty %}
            <span class="sold-out">{% trans "Sold out" %}</span>
            <div class="product-vendor">
                <span class="price"></span><span class="currency"></span>
            </div>
        {% endfor %}
        {% endwith %}
    </div>

    {% if object.original_currency %}
    <div class="product-original-currency">
        {% blocktrans with object.original_currency|join:", " as original_currency %}The item is sold in {{ original_currency }} and the conversion to SEK is approximate.{% endblocktrans %}
    </div>
    {% endif %}

{% endcache %}
    <ul id="add-menu" class="menu hover-menu">
        <li id="add-to-look">
            <a href="/apparel/look/">{% trans "Add to look" %}</a>
            <form action="{% url apparel.views.add_to_look %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="look" />
            <input type="hidden" name="product" value="{{ object.id }}" />
            <ul>
            {% for look in user_looks %}
                {% include "apparel/fragments/look_button.html" %}
            {% endfor %}
            </ul>
            </form>
        </li>
    </ul>
</div>
{% endif %}

