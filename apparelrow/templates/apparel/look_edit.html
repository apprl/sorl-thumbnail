{% extends 'base.html' %}
{% load i18n %}
{% load thumbnail %}
{% block 'extra-scripts' %}
<script type="text/javascript">
var look = {
    initialize: function(ele, type) {
        ele.resizable({
            aspectRatio: 'true',
            maxHeight: ele.parent().height(),
            maxWidth: ele.parent().width(),
            minHeight: 30,
            minWidth: 30,
            //grid: [10, 10],
            stop: function(event, ui) {
                look.saveProduct(ui, type);
            },
        });
        ele.parent('.ui-wrapper').draggable({
            stack: { group: '.ui-wrapper', min: 50 },
            containment: 'parent',
            //snap: true,
            //grid: [10, 10],
            stop: function(event, ui) {
                look.saveProduct(ui, type);
            },
        });
        jQuery.fn.reverse = jQuery.fn.reverse || [].reverse;
        ele.parent('.ui-wrapper').reverse().each(function() {
            var el = $(this);
            position = el.position();
            el.css({
                position: 'absolute',
                marginLeft: 0,
                marginRight: 0,
                top: position.top,
                left: position.left,
            });
        });
    },
    saveProduct: function(ui, type) {
        product = ui.helper.find('.look');
        data = {
            look: {{ object.id }},
            product: product.attr('id').split('-')[1],
            type: type,
            top: parseInt(ui.position.top),
            left: parseInt(ui.position.left),
            z_index: product.parent('.ui-wrapper').css('z-index'),
        }
        if('size' in ui) {
            data['width'] = parseInt(ui.size.width);
            data['height'] = parseInt(ui.size.height);
        }
        else {
            data['width'] = product.width();
            data['height'] = product.height();
        }
        jQuery.post('{% url apparel.views.save_look_product %}', data,
        function(response) {
            //alert('saved! ' + response);
        });
    },
    disable: function(ele) {
        ele.resizable('disable');
        ele.parent('.ui-wrapper').draggable('disable');
    },
    enable: function(ele) {
        ele.resizable('enable');
        ele.parent('.ui-wrapper').draggable('enable');
    },
};
    jQuery(document).ready(function() {
        look.initialize(jQuery('#collage .look'), 'C'); // FIXME: We should get look product type from the model
        look.initialize(jQuery('#photo .look'), 'P');
        look.disable(jQuery('.look'));
        jQuery('.look').hover(
            function() {
                look.disable(jQuery('.look'));
                look.enable(jQuery(this));
                return false;
            },
            function() {
                look.disable(jQuery(this));
                return false;
            });
        jQuery('#collage').click(function() {
            look.disable(jQuery('.look'));
        });
        jQuery('ul.tabs').tabs('div.panes > div');
    });
</script>
{% endblock 'extra-scripts' %}

{% block body-classes %}two-columns{% endblock %}

{% block body %}
<form enctype="multipart/form-data" action="" method="POST">
<div id="look-title">
    {{ form.title }}<button type="submit">{% trans "Save" %}</button>
</div>
<div>{{ form.title.errors }}</div>
<div>{{ form.slug.errors }}</div>
<div>{{ form.description.errors }}</div>
<div>{{ form.user.errors }}</div>
<div>{{ form.image.errors }}</div>
<div>{{ form.created.errors }}</div>
<div>{{ form.modified.errors }}</div>
<div>{{ form.tags.errors }}</div>
<div class="sidebar">
    <label for="id_description">{% trans "Description (optional):" %}</label>
    {{ form.description }}
    <label for="id_tags">{% trans "Tags:" %}</label>
    {{ form.tags }}
</div>
<div id="content">
    <div id="edit-look">
        <ul class="tabs">
            <li><a class="collage" href="#collage">{% trans "Collage" %}</a></li>
            <li><a class="photo" href="#photo">{% trans "Photo" %}</a></li>
            <li><a class="selection" href="#selection">{% trans "Selection" %}</a></li>
        </ul>
        <div class="panes">
            <div id="collage">
            {% include 'apparel/fragments/look_collage.html' %}
            </div>
            {% include 'apparel/fragments/look_picture.html' %}
            <div id="selection"></div>
        </div>
    </div>
</div>
</form>
{% endblock body %}
