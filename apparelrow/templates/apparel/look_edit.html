{% extends 'base.html' %}
{% load i18n %}
{% load thumbnail %}
{% block 'extra-styles' %}
<link rel="stylesheet" href="{{ MEDIA_URL }}/styles/jquery.ui.rotatable.css" type="text/css" media="screen, projection">
{% endblock 'extra-styles' %}
{% block 'extra-scripts' %}
<script type="text/javascript" src="{{ MEDIA_URL }}/js/jquery.ui.rotatable.js"></script>
<script type="text/javascript">


var look = {
    initialize: function(ele) {
        var pane = ele.parent();
        ele.resizable({
            aspectRatio: 'true',
            maxHeight: ele.parent().height(),
            maxWidth: ele.parent().width(),
            minHeight: 30,
            minWidth: 30,
            //grid: [10, 10],
            stop: function(event, ui) {
                look.saveComponent(ui, pane);
            }
        })
        .parent('.ui-wrapper')
        .append(jQuery('<div/>').addClass('delete').click(function() { alert('click') }))
        .rotatable({ handles: 'ne' })
        .draggable({
            stack: '.ui-wrapper',
            containment: 'parent',
            //snap: true,
            //grid: [10, 10],
            stop: function(event, ui) {
                look.saveComponent(ui, pane);
            }
        });
        jQuery.fn.reverse = jQuery.fn.reverse || [].reverse;
        ele.parent('.ui-wrapper').reverse().each(function() {
            var el = jQuery(this);
            position = el.position();
            el.css({
                position: 'absolute',
                marginLeft: 0,
                marginRight: 0,
                top: position.top,
                left: position.left,
                overflow:'visible'
            });
        });
        look.disable(ele);
        
        ele.parent('.ui-wrapper')
            .hover(
                function() {
                    look.disable(jQuery('.product'));
                    look.enable(jQuery('.product', this));
                    return false;
                },
                function() {
                    look.disable(jQuery('.product', this));
                    return false;
                }
            );
        
        // FIXME: Register a handler that calls deleteComponent()
    },
    saveComponent: function(ui, pane) {
        var context = getContextFromPane(pane);
        var product = getProductFromElement(ui);
        
        data = {
            look: {{ object.id }},
            product: product.attr('id').split('-').pop(),
            component_of: context.component_of,
            top: parseInt(ui.position.top),
            left: parseInt(ui.position.left),
            z_index: 50 // FIXME: We need to create a stack
        }
        if('size' in ui) {
            data['width'] = parseInt(ui.size.width);
            data['height'] = parseInt(ui.size.height);
        }
        else {
            data['width'] = product.width();
            data['height'] = product.height();
        }
        jQuery.post('{% url apparel.views.save_look_component %}', data,
            function(response, status, request) {
                var component = response.data.look_component;
                
                if(!response.success) {
                    console.error('Bad AJAX request', response, status, request);
                    return;
                }
                
                if(response.data.added) {
                    var new_product = jQuery(tmpl(context.template, { 'component': component } )).appendTo(pane);
                    look.initialize(new_product);
                }
            }
        );
    },
    deleteComponent: function(ui, pane) {
        var context = getContextFromPane(pane);
        var product = getProductFromElement(ui);
        
        jQuery.post(
            '{% url apparel.views.delete_look_component %}', {
                look: {{ object.id }},
                product: product.attr('id').split('-').pop(),
                component_of: context.component_of
            },
            function(response, status, request) {
                if(response.success) {
                    ui.remove();
                }
            }
        );
    },
    disable: function(ele) {
        ele.resizable('disable');
        ele.parent('.ui-wrapper').draggable('disable');
    },
    enable: function(ele) {
        ele.resizable('enable');
        ele.parent('.ui-wrapper').draggable('enable');
    }
};

function getContextFromPane(pane) {
    var context = {// FIXME: We should get look product type from the model
        'photo': { 'template': 'look_photo_product_template', 'component_of': 'P' },
        'collage': { 'template': 'look_collage_product_template', 'component_of': 'C' }
    }[pane.attr('id')];
    
    if(!context) {
        console.error('Unknown pane', pane);
        return;
    }
    
    return context;
}
function getProductFromElement(ui) {
    console.log(ui);
    var product;
    if('helper' in ui) {
        product = ui.helper.find('.product');
        if(product.length == 0)
            product = ui.draggable;
    } else {
        product = ui.closest('.ui-wrapper').find('.product');
    }
    return product;
}

jQuery(document).ready(function() {
    look.initialize(jQuery('#collage > .product'));
    look.initialize(jQuery('#photo > .product'));

    jQuery('ul.tabs').tabs('div.panes > div');
    jQuery('#wardrobe-contents li').draggable({
        'disabled': false,
        'addClasses': false,
        'helper': 'clone',
        'cursor': 'move',
        'revert': 'invalid',
        'appendTo': '#edit-look .panes'
    });
    jQuery('#selection,#photo,#collage').droppable({
        'accept': '#wardrobe-contents li',
        'drop': function(event, ui) {
            var product_id = ui.draggable.attr('id').split('-').pop();
            jQuery.post('{% url apparel.views.add_to_look %}', {
                'look': '{{ object.id }}',
                'product': product_id
            }, function(response, status, request) {
                if(response.success == false) {
                    alert('something went wrong');
                    return;
                }
                
                if(response.data.added) {
                    var product = ui.draggable.clone();
                        product.removeAttr('id');
                    
                    jQuery('#selection .row ul').append(product);
                }
                
                if(event.target.id != 'selection')
                    look.saveComponent(ui, $(event.target));
            } );
        }
    })
});
</script>
{% endblock 'extra-scripts' %}

{% block body-classes %}edit-look two-columns{% endblock %}

{% block body %}
<form enctype="multipart/form-data" action="" method="POST">
<div id="look-title">
    {{ form.title }}<button type="submit">{% trans "Save" %}</button>
</div>
<div>{{ form.title.errors }}</div>
<div>{{ form.slug.errors }}</div>
<div>{{ form.description.errors }}</div>
<div>{{ form.user.errors }}</div>
<div>{{ form.image.errors }}</div>
<div>{{ form.created.errors }}</div>
<div>{{ form.modified.errors }}</div>
<div>{{ form.tags.errors }}</div>
<div class="sidebar">
    <label for="id_description">{% trans "Description (optional):" %}</label>
    {{ form.description }}
    <label for="id_tags">{% trans "Tags:" %}</label>
    {{ form.tags }}
</div>
<div id="content">
    <div id="edit-look">
        <ul class="tabs">
            <li class="first"><a class="collage" href="#collage">{% trans "Collage" %}</a></li>
            <li><a class="photo" href="#photo">{% trans "Photo" %}</a></li>
            <li class="last"><a class="selection" href="#selection">{% trans "Selection" %}</a></li>
        </ul>
        <div class="panes">
            <div id="collage">
            {% include 'apparel/fragments/look_collage.html' %}
            </div>
            {% include 'apparel/fragments/look_picture.html' %}
            <div id="selection">
            {% with object.products.all as products %}
            {% include 'apparel/fragments/product_row.html' %}
            {% endwith %}
            </div>
        </div>
    </div>
</div>
</form>
<div id="wardrobe">
    <div id="wardrobe-title">
        <span>{% trans "Your wardrobe" %}</span>
    </div>
    <div id="wardrobe-contents">
        {% with "wardrobe" as id_prefix %}
        {% with wardrobe as products %}
        {% include 'apparel/fragments/product_row.html' %}
        {% endwith %}
        {% endwith %}
    </div>
</div>
{% endblock body %}
