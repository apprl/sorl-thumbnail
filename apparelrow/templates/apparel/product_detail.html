{% extends 'base.html' %}
{% load i18n %}
{% load thumbnail %}
{% load comments %}
{% load trackback_tags %}
{% load apparel_extras %}
{% load cache %}

{# FIXME: we should reverse the list of categories. I think we need to create a filter for this #}
{% block extra-title %}{{ object.product_name }} {% trans "by" %} {{ object.manufacturer }} | {{ object.categories|join:' | ' }} | {% endblock %}

{% block 'extra-styles' %}
    <link rel="pingback" href="{% get_pingback_url %}" />
    {% get_trackback_rdf_for object %}
{% endblock 'extra-styles' %}

{% block 'extra-scripts' %}
    <script type="text/javascript">
        jQuery(document).ready(function() {
            jQuery('.product-image').mouseenter(function() {
                jQuery(this).find('.magnifier').fadeIn('slow');
                return false;
            }).mouseleave(function() {
                jQuery(this).find('.magnifier').fadeOut('slow');
                return false;
            });


            // Gallery overlay
            var gallery_overlay = false;
            jQuery('.product-image a').click(function(event) {
                gallery_overlay = true;
                jQuery('#gallery-container').show();
                return false;
            });
            jQuery(document).click(function(event) {
                if(gallery_overlay) {
                    gallery_overlay = false;
                    jQuery('#gallery-container').hide();
                }
            }).keydown(function(event) {
                if (event.keyCode == 27 && gallery_overlay) {
                    gallery_overlay = false;
                    jQuery('#gallery-container').hide();
                }
            });

            jQuery('#add-to-look').bind('click mouseenter mouseleave', function(event) {
                var sub_menu = jQuery(this).find('ul');
                if(event.type == 'mouseenter' || (event.type == 'click' && sub_menu.is(':hidden'))) {
                    sub_menu.show();
                } else {
                    sub_menu.hide();
                    jQuery(this).find('#add-to-look-new button').show(); 
                    jQuery(this).find('#add-to-look-new input[name=new_name]').hide(); 
                }
                // Should prevent default only when #add-to-look button is clicked
                if(event.type == 'click' && event.target == jQuery('#add-to-look > a').get(0))
                    event.preventDefault();
            });

            jQuery('#add-to-look>form').hyperSubmit({
                beforeSend: function(req) {
                    link = jQuery('#add-to-look a[href=/apparel/look/]');
                    text = link.text();
                    link.text('{% trans "Adding..." %}');
                },
                complete: function() {
                    jQuery('#add-to-look>form>input[type=hidden][name=look]').attr('value', '');
                },
                success: function(response, statusText, req) {
                    if(response.data['created']) {
                        jQuery('#add-to-look-new').before(response.data.created_html)
                    }

                    if(response.data['added']) {
                        increase_counts(jQuery('h2#looks > span.count, a.looks > span.count'));
                        jQuery('h2#looks.hidden, p.hidden:has(a.looks)').fadeIn().removeClass('hidden');
                        jQuery('<li/>').append(response.data.html).prependTo('.sidebar > ul.looks');
                        jQuery('.sidebar > ul.looks > li').each(function(i, item) {
                            if(i % 2 == 1)
                                jQuery(item).addClass('last');
                            else
                                jQuery(item).removeClass('last');
                        });
                        /* FIXME uncommented this, for now. We need to do something more smart with templates.
                        jQuery('<li/>').append(response.data.template, { 'object': response.data.look }).prependTo('ul.looks');
                        */
                        
                        var p = jQuery('#inner-container .product-image img');
                        var w = 76;                             // FIXME: Read from constant
                        var h = parseInt(p.height() / (p.width() / w));   // FIXME: At the moment we need both height and width to draw edit pane. This should not be the case really

                        // Add the product to the collage if we're adding the product to the look
                        jQuery.post('{% url apparel.views.save_look_component %}', {
                                'component_of': 'C',
                                'product': jQuery('#add-to-look>form>input[name=product]').attr('value'),
                                'look': response.data.look.id,
                                'width': w,
                                'height': h
                            },
                            function(response, status, request) {
                                if(response.success) {
                                    console.debug('Added product to collage');
                                } else {
                                    console.error('Bad AJAX request', response, status, request);
                                    return;
                                }
                            }
                        );
                    }

                    link.text(text);
                    input = jQuery('#add-to-look-new input[name=new_name]');
                    input.hide();
                    input.value = input.defaultValue;
                    
                    jQuery('#add-to-look-new button').show();
                    return false;
                    // FIXME: Show the new look in list. Should we reload or just display?
                },
                error: function(error, req) {
                    link.text = text;
                }
            });
            jQuery('#add-to-look button[name=look]').live('click', function() {
                this.form.elements.look[0].value = this.value;
            });
            jQuery('#add-to-look-new button').click(function() {
                jQuery(this).hide();
                jQuery(this).siblings('input[name=new_name]').show().focus();
                return false;
            });
            jQuery('#add-to-look-new input[name=new_name]')
                .hide()
                .focus(function() { if(this.value == this.defaultValue) this.select() })
                .blur(function()  { if(this.value == '') this.value = this.defaultValue })
                .bind('keypress', function(e) { if(e.keyCode == 13) { jQuery('#add-to-look>form').submit(); return false } return true})

            var is_add = jQuery('#add-to-wardrobe > form').hasClass('add');
            jQuery('#add-to-wardrobe > form').hyperSubmit({
                beforeSend: function(req) {
                    btn = jQuery('#add-to-wardrobe form button[type=submit]');
                    if(is_add) {
                        btn.text('{% trans "Adding..." %}');
                    } else {
                        btn.text('{% trans "Deleting..." %}');
                    }
                    btn.click(function() { return false });
                },
                success: function(data, statusText, req) {
                    if(is_add) {
                        btn.text('{% trans "In wardrobe" %}').attr('title', '{% trans "Delete product from my wardrobe" %}');
                        jQuery('#add-to-wardrobe form').attr('action', '{% url apparel.views.delete_from_wardrobe %}');
                    } else {
                        btn.text('{% trans "Add to wardrobe" %}').attr('title', '{% trans "Add to wardrobe" %}');
                        jQuery('#add-to-wardrobe form').attr('action', '{% url apparel.views.add_to_wardrobe %}');
                    }
                    is_add = !is_add;
                    btn.unbind('click');
                },
                error: function(data, statusText, req) {
                    if(is_add) {
                        btn.text('{% trans "Add to wardrobe" %}').attr('title', '{% trans "Add to wardrobe" %}');
                    } else {
                        btn.text('{% trans "In wardrobe" %}').attr('title', '{% trans "Delete product from my wardrobe" %}');
                    }
                    is_add = !is_add;
                    btn.unbind('click');
                }
            });

            // More like this scrollable
            jQuery('#more-like-this .row').simple_scrollable(532);

            // Recently viewed scrollable
            jQuery('#recentlyviewed .row').simple_scrollable();
        });
    </script>
{% endblock 'extra-scripts' %}

{% block body-classes %}product two-columns right{% endblock %}

{% block body %}

<div class="product-back">
    {% if request.META.HTTP_REFERER and CURRENT_DOMAIN in request.META.HTTP_REFERER %}
    <a href="{{ request.META.HTTP_REFERER }}" onClick="history.back(1);return false;">{% trans "Back" %}</a>
    {% endif %}
</div>

{% if object %}
{% url apparel.views.product_user_like_list object.slug as likes_url %}
        <div class="product-left">
            <div class="product-image">
                <a href="{{ object.product_image.url }}" title="{{ object.manufacturer }} - {{ object.product_name }}"><img src="/scale/328x500{{ object.product_image.url }}" /></a>
                {% url apparel.views.product_like object.slug 'like' as like_url %}
                {% url apparel.views.product_like object.slug 'unlike' as unlike_url %}
                {% url dialog-like-product as dialog_url %}
                {% with user|likes_product:object as is_liked %}
                {% include 'apparel/fragments/like_button.html' %}
                {% endwith %}
            </div>
            <div id="gallery-container">
                <div id="gallery">
                    <div class="close"></div>
                    <img src="/scale/960{{object.product_image.url}}" alt="{{Â object.product_name }}">
                </div>
            </div>
            {% include 'apparel/fragments/comments.html' %}
        </div>
        <div class="product-right">
            <div class="product-content">
                {% get_trackbacks_for object as trackbacks %}
                {% include 'apparel/fragments/product_detail.html' %}
                <div class="sidebar last">
                    {% get_comment_count for object as comment_count %}
                    <div class="activity">
                        {% include 'apparel/fragments/comment_count.html' %}
                        <p{% if not looks_with_product %} class="hidden"{% endif %}><a class="looks" href="#looks">{% blocktrans count looks_with_product_count as counter %}Added to <span class="count">{{ counter }}</span> look{% plural %}Added to <span class="count">{{ counter }}</span> looks{% endblocktrans %}</a></p>
                        <p class="last">{% include 'apparel/fragments/likes_link.html' %}</p>
                    </div>
                    {% if viewed_products %}
                    <h2>{% trans "Recently viewed" %}</h2>
                    <div id="recentlyviewed">
                        {% with viewed_products as products %}
                        {% include 'apparel/fragments/product_row.html' %}
                        {% endwith %}
                    </div>
                    {% endif %}
                    <div class="product-looks">
                        <a href="looks"><h2 id="looks"{% if not looks_with_product %} class="hidden"{% endif %}>
                            {% blocktrans count looks_with_product_count as counter %}<span class="count">{{ counter }}</span> look with this product{% plural %}<span class="count">{{ counter }}</span> looks with this product{% endblocktrans %}
                        </h2></a>
                        {% with looks_with_product as looks %}
                        {% include 'apparel/fragments/looks.html' %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            <div class="product-similar">
                {% if more_like_this %}
                    <h2>{% trans "You may also like" %}</h2>
                    <div id="more-like-this">
                        <a class="prev">{% trans "Previous" %}</a>
                        <div class="row">
                            <ul>
                            {% for product in more_like_this %}
                                {{ product.template_mlt|safe }}
                            {% endfor %}
                            </ul>
                        </div>
                        <a class="next">{% trans "Next" %}</a>
                    </div>
                {% endif %}
            </div>
        </div>
{% else %}
    <!-- FIXME: This needs some sort of layout -->
    <p>{% trans "No product found!" %}</p>
{% endif %}
{% endblock body %}

