{% extends 'base.html' %}
{% load i18n %}
{% load mptt_tags %}

{% block extra-title %}{% trans "Browse" %} | {% endblock %}

{% block 'extra-styles' %}
    <style type="text/css">
        .tooltip {
            display: none;
            width: 699px;
            height: 478px;
            -moz-box-shadow: 0 0 1em black;
            -webkit-box-shadow: 0 0 1em black;
            z-index: 200;
        }
    </style>
{% endblock 'extra-styles' %}
{% block 'extra-scripts' %}
    <script type="text/javascript" src="/site_media/static/js/jquery.fixedscroll.js"></script>
    <script type="text/javascript" src="/site_media/static/js/filtersetup.js"></script>
    <script type="text/javascript">
        /*
        jQuery(window).load(function() {
            if(window.location.hash) {
                doFilter(window.location.hash.substr(1));
            }
        });
        */
        var pricerange = {
            min: {{ pricerange.min }},
            max: {{ pricerange.max }}
        }
        jQuery(document).ready(function() {
            // Tooltips FIXME: Fix this, so it works with ajax fetched stuff and looks nice
            // jQuery('#product-list > ul > li').tooltip({ effect: 'slide', position: 'bottom center', offset: [170, 0], relative: true });
            // Fixed scrolling
            //jQuery('#content').fixedscroll();
            // Reset button
            jQuery('#reset').click(function() {
                $('.selected').removeClass('selected');
                filter(getQuery());
                return false;
            });
            jQuery('.options li > a').click(function() {
                jQuery(this).toggleClass('selected');
                return false;
            });
            jQuery('#product-price form').submit(function() {
                filter(getQuery({criterion: 'price'}));
                return false;
            });
            jQuery('#product-color form').submit(function() {
                filter(getQuery({criterion: 'color'}));
                return false;
            });
            jQuery('#product-manufacturers form').submit(function() {
                filter(getQuery({criterion: 'manufacturer'}));
                return false;
            });
            jQuery('#product-gender li > a').click(function() {
                jQuery(this).toggleClass('selected');
                jQuery(this).parent().siblings().find('a').removeClass('selected');
                filter(getQuery());
                return false;
            });
            jQuery('#product-category li > a').click(function() {
                filter(getQuery({ criterion: 'category'}));
                return false;
            });
            jQuery('#pagination a').live('click', function() {
                //filter(getQuery($(this).attr('href').split('=')[1]));
                var page = parseInt(jQuery(this).attr('href').split('=')[1]);
                if(jQuery('#page-' + page).length == 0) {
                    filter(getQuery({page: page}), function(response) {
                        renderPage(response, page);
                        jQuery('#product-list').scrollable().reload().setPage(jQuery('#page-' + page).index());
                    });
                } else {
                    jQuery('#product-list').scrollable().reload().setPage(jQuery('#page-' + page).index());
                }
                return false;
            });
            var product_list = jQuery('#product-list').scrollable({
                api: true,
                items: 'ul.list',
                prevPage: '.prev',
                nextPage: '.next',
                size: 1,
            });
        });
        function getQuery(query) {
            index = 0;
            query = query || {};
            category_list = getElementIds(jQuery('#product-category li > a.selected'));
            if(category_list.length > 0) {
                query[++index + ':c.id:in'] = category_list.join(',');
            }
            manufacturer_list = getElementIds(jQuery('#product-manufacturers li > a.selected'));
            if(manufacturer_list.length > 0) {
                query[++index + ':m.id:in'] = manufacturer_list.join(',');
            }
            gender_list = getElementIds(jQuery('#product-gender li > a.selected'));
            if(gender_list.length > 0) {
                query[++index + ':o.gender:in'] = gender_list.join(',');
            }
            color_list = getElementIds(jQuery('#product-color li > a.selected'));
            if(color_list.length > 0) {
                query[++index + ':o.color:in'] = color_list.join(',');
            }
            if(jQuery('#product-price > a').is('.selected')) {
                query[++index + ':vp.price:range'] = jQuery('#price-slider').slider('values', 0) + ',' + jQuery('#price-slider').slider('values', 1);
            }
            
            return query;
        }
        function getElementIds(elements) {
            return jQuery.map(elements, function(element) {
                return element.id.split('-')[1];
            });
        }
        
        function filter(query, callback) {
            q = jQuery.param(query);
            window.location.hash = q ? q : "!";
            doFilter(query, callback);
        }
        function doFilter(query, callback) {
            jQuery.getJSON('{% url apparel.views.search "products" %}', query, callback || renderProducts);
        }
        function renderPage(products, page) {
            // FIXME: This should probably be moved into a template, but it's kind of simple so it'll do for now
            var pageList = jQuery('<ul></ul>');
            var newPage = jQuery('<li></li>').attr('id', 'page-' + page).append(pageList);
            var existingPages = jQuery('#product-list > ul.list > li')
            var nextPage = existingPages.filter(function(i) { return this.id.split('-')[1] > parseInt(page) }).first();
            if(nextPage.length == 1) {
                nextPage.before(newPage);
            } else if(existingPages.length > 0) {
                existingPages.last().after(newPage);
            } else {
                jQuery('#product-list > ul.list').append(newPage);
            }
            jQuery.each(products.object_list, function(i, product) {
                pageList.append(tmpl('product_template', { product: product }));
            });
            try {
                $('#pagination').empty();
                $('#pagination').append(tmpl('pagination_template', { products: products }));
            } catch(e) {
                console.log(e)
            }
        }
        function filterCriteria(criteria_filter) {
            if('manufacturers' in criteria_filter) {
                applyCriteriaFilter({ 
                    'selector': '#product-manufacturers .option-content li > a', 
                    'criteria': criteria_filter['manufacturers'],
                    'add': function(o) { jQuery(o).parent().addClass('filtered'); },
                    'remove': function(o) { jQuery(o).parent().removeClass('filtered');  },
                });
            }
            
            if('categories' in criteria_filter) {
                applyCriteriaFilter({ 
                    'selector': '#product-category li > a', 
                    'criteria': criteria_filter['categories'],
                    'add': function(o) { jQuery(o).parent().addClass('filtered'); },
                    'remove': function(o) { jQuery(o).parent().removeClass('filtered');  },
                });
            }
            
            if('options' in criteria_filter) {            
                applyCriteriaFilter({ 
                    'selector': '#product-color .option-content li > a', 
                    'criteria': criteria_filter['options'],
                    'add': function(o) { jQuery(o).addClass('filtered'); },
                    'remove': function(o) { jQuery(o).removeClass('filtered');  },
                });

                // FIXME: Add size here aswell
            }
        }
        
        function applyCriteriaFilter(args) {
            //selector, criteria, cb_add, cb_remove) {
            jQuery(args.selector).each(function() {
                if (args.criteria.length == 0 || jQuery.inArray(this.id.split('-')[1], args.criteria) >= 0) {
                    args.remove(this);
                } else {
                    args.add(this);
                }
            });
        }
        
        function renderProducts(products) {
            $('#product-count').empty();
            $('#product-count').append(tmpl('product_count_template', { products: products }));
            jQuery('#product-list > ul').empty();
            renderPage(products, 1);
            jQuery('#product-list').scrollable().begin();
            filterCriteria(products.criteria_filter);
            
        }
    </script>
{% endblock 'extra-scripts' %}

{% block body-classes %}two-columns{% endblock body-classes %}

{% block body %}
        <div class="sidebar">
            {% include 'apparel/fragments/product_menu.html' %}
        </div>
        <div id="content">
            {% with pages|first as products %}
            <h2><span id="product-count">{% include 'apparel/fragments/product_count.html' %}</span> {% trans "products" %}</h2>
            {% endwith %}
            <div id="product-list">
                <ul class="list">
                    {% for page in pages %}
                    <li id="page-{{ page.number }}"><ul>
                        {% for product in page.object_list %}
                        {% include 'apparel/fragments/product_small.html' %}
                        {% endfor %}
                    </ul></li>
                    {% endfor %}
                    {% comment %}
                    FIXME: Fix this so it works with ajax fetched stuff and looks nice
                    {% with product as object %}
                    <div class="tooltip">
                        {% include 'apparel/fragments/product_detail.html' %}
                    </div>
                    {% endwith %}
                    {% endcomment %}
                        </ul>
                    </li>
            </ul>
            <div id="pagination">
            {% with pages|first as products %}
                {% include 'apparel/fragments/pagination.html' %}
            {% endwith %}
            </div>
        </div>
        </div>
        <script type="text/html" id="product_count_template">
        <![CDATA[
            {{ product_count_template|safe }}
        ]]>
        </script>
        <script type="text/html" id="pagination_template">
        <![CDATA[
            {{ pagination_template|safe }}
        ]]>
        </script>
        <script type="text/html" id="product_template">
        <![CDATA[
            {{ product_template|safe }}
        ]]>
        </script>
{% endblock body %}
