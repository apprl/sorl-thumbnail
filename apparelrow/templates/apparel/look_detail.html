{% extends 'base.html' %}
{% load i18n humanize comments cache apparel_extras %}

{% block extra-title %}{{ object.title }} {% trans "by" %} {{ object.user.display_name }} | {% trans "Looks" %} | {% endblock %}

{% block head-data %} prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# {{ FACEBOOK_OG_TYPE }}: http://ogp.me/ns/fb/{{ FACEBOOK_OG_TYPE }}#"{% endblock head-data %}

{% block extra-styles %}
    {% cache CACHE_TIMEOUT look_detail_metaextra object.id LANGUAGE_CODE %}
    <meta property="og:title" content="{{ object.title }}"/>
    <meta property="og:type" content="{{ FACEBOOK_OG_TYPE }}:look"/>
    <meta property="og:image" content="{{ look_full_image }}"/>
    <meta property="og:url" content="{{ object_url }}"/>
    <meta property="og:description" content="{% if object.product_brands_unique %}{{ object.product_brands_unique|join:", " }}{% endif %}"/>
    <meta property="og:site_name" content="{{ CURRENT_NAME }}"/>
    <meta property="fb:app_id" content="{{ FACEBOOK_APP_ID }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:likes" content="{{ object.score }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:products" content="{{ object.display_components.count }}"/>
    {% endcache %}
{% endblock extra-styles %}

{% block 'extra-scripts' %}
<script type="text/javascript">
    jQuery(document).ready(function() {
        jQuery('#embed-code, #url-code')
            .focus(function(e) { this.select(); })
            .mouseup(function(e) { e.preventDefault() });

        jQuery('#look-header .btn-delete').click(function(event) {
            var title = jQuery(this).attr('title');
            var href = jQuery(this).attr('href');
            create_modal_dialog(
                '{% trans "Are you sure?" %}',
                ['{% trans "Do you really want to delete look" %} <span class="bold">' + title + '</span>?'],
                function (modal_dialog) { location.href = href; },
                function (modal_dialog) { modal_dialog.close(); }
            );
            event.preventDefault();
        });

        $('#look-header')
            .on('click', '.btn-publish', function(e) {
                var $this = $(this);
                var text = $this.text();
                var href = $this.attr('href');
                var new_text = $this.data('text');
                var new_href = $this.data('href');
                create_modal_dialog(
                    '{% trans "Publish look" %}',
                    ['{% trans "Do you want to publish this look?" %}'],
                    function (modal_dialog) {
                        $.ajax({url: href,
                                success: function(data) {
                                    $this.data('text', text);
                                    $this.data('href', href);
                                    $this.text(new_text).attr('href', new_href).addClass('btn-unpublish').removeClass('btn-publish');
                                },
                                complete: function() { modal_dialog.close(); }
                            });
                    },
                    function (modal_dialog) { modal_dialog.close(); }
                );
                return false;
            })
            .on('click', '.btn-unpublish', function(e) {
                var $this = $(this);
                var text = $this.text();
                var href = $this.attr('href');
                var new_text = $this.data('text');
                var new_href = $this.data('href');
                create_modal_dialog(
                    '{% trans "Unpublish look?" %}',
                    ['{% trans "Are you sure you want to unpublish this look so that no one can see it?" %}'],
                    function (modal_dialog) {
                        $.ajax({url: href,
                            success: function(data) {
                                    $this.data('text', text);
                                    $this.data('href', href);
                                    $this.text(new_text).attr('href', new_href).addClass('btn-publish').removeClass('btn-unpublish');
                                },
                                complete: function() { modal_dialog.close(); }
                            });
                    },
                    function (modal_dialog) { modal_dialog.close(); }
                );
                return false;
            });

        {% if look_created %}
        try {
            _gaq.push(['_trackEvent', 'Look', 'Create', '{{ object.title }}']);
        } catch(err){}
        {% endif %}

        {% if look_saved %}
        ApparelActivity.notification('create', 'look', {{ object.id }});
        {% endif %}
    });

</script>
{% endblock 'extra-scripts' %}

{% block meta_description %}
    {% cache CACHE_TIMEOUT look_detail_metadesc object.id LANGUAGE_CODE %}
    {% if object.description %}{{ object.description }} - {% endif %}{{ object.category_and_brand|join:', ' }}
    {% endcache %}
{% endblock %}

{% block body-header %}
<div id="body-header">
    <div class="column_one">
        <h1>{{ object.title }}{% if not object.published %} ({% trans "Draft" %}){% endif %}</h1>
        <h2>{% trans "by" %} <a href="{{ object.user.get_absolute_url }}">{{ object.user.display_name }}</a></h2>
    </div>
    {% include 'apparel/fragments/create_look_button.html' with request=request only %}
</div>
{% endblock body-header %}
{% block body-classes %}look two-columns{% endblock body-classes %}
{% block body %}
<div id="look-header">
    <a href="{{ object.user.get_absolute_url }}"><img src="{{ object.user.avatar }}" class="profile-image" /></a>
    <div class="look-header-content">
        {% if object.user != request.user %}
            {% include 'apparel/fragments/follow.html' with profile=object.user %}
        {% else %}
            <a class="btn btn-small btn-positive btn-edit" href="{% url 'look-editor' object.slug %}">{% trans "Edit" %}</a>
            <a class="btn btn-small btn-negative btn-delete" title="{{ object.title }}" href="{% url 'look-delete' object.slug %}">{% trans "Delete" %}</a>
            {% if object.published %}
            <a class="btn btn-small btn-positive btn-unpublish" data-href="{% url 'look-publish' object.slug %}" data-text="{% trans "Publish" %}" title="{{ object.title }}" href="{% url 'look-unpublish' object.slug %}">{% trans "Unpublish" %}</a>
            {% else %}
            <a class="btn btn-small btn-positive btn-publish" data-href="{% url 'look-unpublish' object.slug %}" data-text="{% trans "Unpublish" %}" title="{{ object.title }}" href="{% url 'look-publish' object.slug %}">{% trans "Publish" %}</a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="sidebar">
{% cache CACHE_TIMEOUT look_detail1 object.id LANGUAGE_CODE %}
    <div class="info">
        {% if object.description %}
        <p class="description">{{ object.description }}</p>
        {% endif %}
        <ul class="brands">
        {% for text, product in object.category_and_brand_with_product %}
            <li><a href="{% internal_referral_url product.get_absolute_url object.user.pk %}">{{ text }}</a></li>
        {% endfor %}
        </ul>
        {% include 'apparel/fragments/total_price.html' %}
        <p class="created">{% trans "Created" %} {{ object.created|since }}</p>
    </div>
{% endcache %}
    <h2>{% trans "Likes" %}</h2>
    <ul id="likes" class="group">
    {% for like in likes %}
        {% if like.user and like.user %}
        <li{% if forloop.counter|divisibleby:6 %} class="last-column"{% endif %}>
            <a href="{{ like.user.get_absolute_url }}" title="{{ like.user.display_name }}">
                <img alt="{{ like.user.display_name }}" title="{{ like.user.display_name }}" src="{{ like.user.avatar }}">
            </a>
        </li>
        {% endif %}
    {% endfor %}
    </ul>
{% cache CACHE_TIMEOUT look_detail2 object.id LANGUAGE_CODE %}
    <div class="spread">
        <div class="share">
            <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
                <a class="addthis_button_facebook"></a>
                <a class="addthis_button_pinterest_share"></a>
                <a class="addthis_button_twitter"></a>
                <a class="addthis_button_google_plusone_share"></a>
                <a class="addthis_button_email"></a>
            </div>
            <script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
            <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-500ff11c3e1dc781"></script>
        </div>
        <div class="first">
            <label>{% trans "Embed this look on your blog or site" %}:
                <input type="text" value="{% filter force_escape %}{% include 'apparel/fragments/look_widget.html' %}{% endfilter %}" id="embed-code">
            </label>
        </div>
        <div class="last">
            <label>{% trans "Direct link to this page" %}:<input type="text" value="{% filter force_escape %}{{ object_url }}{% endfilter %}" id="url-code"></label>
        </div>
    </div>
    {% if looks_by_user %}
    <h2>{% trans "More looks by" %} {{ object.user.display_name }}</h2>
    {% with looks_by_user as looks %}
    {% include 'apparel/fragments/looks.html' %}
    {% endwith %}
    <a class="btn btn-block btn-upper" href="{{ looks_url }}">{% trans "See all looks" %}</a>
    {% endif %}
</div>
{% endcache %}
<div id="content">
    {# FIXME: Add a "display_as "whatever" or "dispay_as_whatever" property to thge look object rather than checking the flag #}
    {% if object.display_with_component == 'C' %}
        <div class="look-large collage">
            {% cache CACHE_TIMEOUT look_detail3 object.id LANGUAGE_CODE %}
            {% include 'apparel/fragments/look_collage.html' %}
            {% endcache %}
            <a class="look-like heart{% if user|likes_look:object %} liked{% endif %}" href="#" data-dialog-url="{% url 'dialog-like-look' %}" data-like-url="{% url 'look-like' object.slug 'like' %}" data-unlike-url="{% url 'look-like' object.slug 'unlike' %}" data-slug="{{ object.slug }}" data-id="{{ object.id }}"></a>
        </div>
    {% else %}
        <div class="look-large photo">
            {% cache CACHE_TIMEOUT look_detail3 object.id LANGUAGE_CODE %}
            {% include 'apparel/fragments/look_photo.html' %}
            {% endcache %}
            <a class="look-like heart{% if user|likes_look:object %} liked{% endif %}" href="#" data-dialog-url="{% url 'dialog-like-look' %}" data-like-url="{% url 'look-like' object.slug 'like' %}" data-unlike-url="{% url 'look-like' object.slug 'unlike' %}" data-slug="{{ object.slug }}" data-id="{{ object.id }}"></a>
        </div>
    {% endif %}
    {% include 'apparel/fragments/comments.html' %}
</div>
{% endblock body %}
