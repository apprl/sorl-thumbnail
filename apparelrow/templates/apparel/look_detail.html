{% extends 'base.html' %}
{% load i18n humanize comments cache apparel_extras thumbnail %}

{% block extra-title %}{{ object.title }} {% trans "by" %} {{ object.user.display_name }} | {% trans "Looks" %} | {% endblock %}

{% block head-data %} prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# {{ FACEBOOK_OG_TYPE }}: http://ogp.me/ns/fb/{{ FACEBOOK_OG_TYPE }}#"{% endblock head-data %}

{% block extra-styles %}
    {% cache CACHE_TIMEOUT look_detail_metaextra object.id LANGUAGE_CODE %}
    <link rel="canonical" href="{{ object_url }}">
    <meta property="og:title" content="{{ object.title }}"/>
    <meta property="og:type" content="{{ FACEBOOK_OG_TYPE }}:look"/>
    <meta property="og:image" content="{{ look_full_image }}"/>
    <meta property="og:url" content="{{ object_url }}"/>
    <meta property="og:description" content="{% if object.product_brands_unique %}{{ object.product_brands_unique|join:", " }}{% endif %}"/>
    <meta property="og:site_name" content="{{ CURRENT_NAME }}"/>
    <meta property="fb:app_id" content="{{ FACEBOOK_APP_ID }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:likes" content="{{ object.score }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:products" content="{{ components|length }}"/>
    {% endcache %}
{% endblock extra-styles %}

{% block extra-scripts %}
<script type="text/javascript">
    $(document).ready(function() {
        var popover_elements = $('[data-toggle=popover]');
        var is_touch_device = ("ontouchstart" in window) || window.DocumentTouch && document instanceof DocumentTouch;
        var timeout = null;

        popover_elements.each(function(i, element) {
            $(element).popover({
                html: true,
                trigger: 'manual',
                content: $(element).next().html()
            });
        });

        $(document).on('click', function(e) {
            popover_elements.popover('hide');
        });

        if(!is_touch_device) {
            $(document).on('mouseenter', '.popover', function() { clearTimeout(timeout); });
            popover_elements.on('mouseenter', function() {
                clearTimeout(timeout);
                var $element = $(this);
                popover_elements.not($element).popover('hide');
                $element.popover('show');
            }).on('mouseleave', function (e) {
                var $element = $(this);
                timeout = setTimeout(function() { $element.popover('hide'); }, 400);
            });
        }

        popover_elements.on('click', function(e) {
            var $element = $(this);
            popover_elements.not($element).popover('hide');
            if(is_touch_device) {
                $element.popover('show');
                return false;
            }
        });

        {% if look_created %}
        try {
            ga('send', 'event', 'Look', 'Create', '{{ object.slug }}');
            _gaq.push(['_trackEvent', 'Look', 'Create', '{{ object.slug }}']);
        } catch(err){}
        {% endif %}

        {% if look_saved %}
        ApparelActivity.notification('create', 'look', {{ object.id }});
        {% endif %}
    });

</script>
{% endblock extra-scripts %}

{% block meta_description %}
    {% cache CACHE_TIMEOUT look_detail_metadesc object.id LANGUAGE_CODE %}
    {% if object.description %}{{ object.description }} - {% endif %}{{ object.category_and_brand|join:', ' }}
    {% endcache %}
{% endblock %}

{% block body-classes %}look-detail-page{% endblock body-classes %}
{% block full-body %}


    <div class="container" itemscope itemtype="http://data-vocabulary.org/Product">
        <div class="body-header">
            <hgroup>
                <h1>{{ object.title }} <span class="draft-text{% if object.published %} published{% endif %}">({% trans "Not published" %})</span></h1>
                <img class="img-circle" style="padding-top:5px;" width="60" height="60" src="{{ object.user.avatar }}"/>
                <h3>{% trans "by" %} <a href="{{ object.user.get_absolute_url }}">{{ object.user.display_name }}</a></h3>
            </hgroup>

            {% if request.user.is_authenticated %}
            <a class="btn btn-default btn-lg btn-look-like{% if is_liked %} liked{% endif %}" href="#" data-liked-text="{% trans "Liked" %}" data-unlike-text="{% trans "Unlike" %}" data-like-text="{% trans "Like" %}" data-like-url="{% url 'look-like' object.slug 'like' %}" data-unlike-url="{% url 'look-like' object.slug 'unlike' %}" data-slug="{{ object.slug }}" data-id="{{ object.id }}"><i class="fa fa-heart"></i>&nbsp;<span>{% if is_liked %}{% trans "Liked" %}{% else %}{% trans "Like" %}{% endif %}</span></a>
            {% else %}
            <a class="btn btn-default btn-lg btn-look-like" data-toggle="modal" href="#" data-target="#modal_like_look"><i class="fa fa-heart"></i>&nbsp;<span>{% trans "Like" %}</span></a>
            {% endif %}
        </div>

        <div class="row">
            <div class="col-md-6">

                <div class="look-main-content">
                    {% if request.user.is_authenticated and request.user == object.user %}
                    <ul class="list-tools">
                        <li><a class="btn btn-primary" href="{% url 'look-editor' object.slug %}"><span class="hidden-xs"><i class="fa fa-pencil"></i>&nbsp;</span>{% trans "Edit" %}</a></li>
                        <li><a class="btn btn-unpublish{% if object.published %} published{% endif %}" data-toggle="modal" href="#" data-target="#modal_look_unpublish_{{ object.id }}"><span class="hidden-xs"><i class="fa fa-lock"></i>&nbsp;</span>{% trans "Unpublish" %}</a></li>
                        <li><a class="btn btn-delete btn-secondary" data-toggle="modal" href="#" data-target="#modal_look_delete_{{ object.id }}"><span class="hidden-xs"><i class="fa fa-times"></i>&nbsp;</span>{% trans "Delete" %}</a></li>
                        <li><a class="btn btn-publish{% if object.published %} published{% endif %}" data-toggle="modal" href="#" data-target="#modal_look_publish_{{ object.id }}"><span class="hidden-xs"><i class="fa fa-times"></i>&nbsp;</span>{% trans "Publish" %}</a></li>
                    </ul>
                    {% endif %}

                    {% cache CACHE_TIMEOUT look_detail_content object.id LANGUAGE_CODE %}
                    {% if object.display_with_component == 'C' %}
                    <div class="look-large collage">
                        <div id="collage-background" class="look-collage">
                            {% thumbnail object.image resolution crop="center" as im %}
                            <img src="{{ im.url }}">
                            {% endthumbnail %}
                            <div class="component-wrapper" style="width: {{ wrapper_element.width }}%; height: {{ wrapper_element.height }}%;">
                                {% for component in object.collage_components.all %}
                                    {% thumbnail component.product.product_image "224x291" crop=False format="PNG" transparent=True as im %}
                                    <a href="{{ component.product.get_absolute_url }}" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="click" class="product collage-image" style="{{ component.style_percentage }}">
                                        <img src="{{ im.url }}" title="{{ component.product }}" style="width:{{ im.width }}px;height:{{im.height}}px;" />
                                    </a>
                                    {% endthumbnail %}
                                    {% include "apparel/fragments/look_product_tooltip.html" with owner=object.user product=component.product only %}
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                    {% else %}
                    <div class="look-large photo">

                        {% thumbnail object.image "720" upscale=False as im %}
                        <div id="photo-background" class="look-photo" style="max-width: {{ im.width }}px;">
                            <img class="img-responsive" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                            {% for component in components %}
                                {% if component.product %}
                                    <a href="{{ component.product.get_absolute_url }}" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="click" class="hotspot product" style="{% look_component_style component im.width im.height %}"></a>
                                    {% include "apparel/fragments/look_product_tooltip.html" with owner=object.user product=component.product only %}
                                {% endif %}
                                {% if component.link %}
                                    <a href="{{ component.link.url }}" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="click" class="hotspot link" style="{% look_component_style component im.width im.height %}"></a>
                                    {% include "apparel/fragments/look_link_tooltip.html" with owner=object.user link=component.link only %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endthumbnail %}

                    </div>
                    {% endif %}
                    {% endcache %}

                    {% if object.description %}
                    <p>{{ object.description }}</p>
                    {% endif %}
                </div>

            </div>
            <div class="col-md-6">

                <div class="row">

                        <div class="col-lg-6">
                    <section class="center-sm">
                            {% cache CACHE_TIMEOUT look_detail object.id LANGUAGE_CODE %}
                            <h4>{% trans "Look details" %}</h4>
                            <hr>
                            <ul class="list-vertical">
                                {% for text, product in object.category_and_brand_with_product %}
                                <li><a href="{% internal_referral_url product.get_absolute_url object.user.pk %}">{{ text }}</a></li>
                                {% endfor %}
                            </ul>

                            <p class="total-price">
                                <span class="price">
                                    {% blocktrans count object.category_and_brand_count as number %}{{ number }} article{% plural %}{{ number }} articles{% endblocktrans %}
                                </span>
                                {% if object.category_and_brand_count > 0 %}
                                <span class="sum"> - {{ object.total_price|floatformat:0|apprl_intcomma }} {{ CURRENCY }}</span>
                                {% endif %}
                            </p>
                            <p class="created">{% trans "Created" %} {{ object.created|since }}</p>
                            {% endcache %}

                            {% comment %}
                                Removed exclusive access, ticket #65018758
                            {% if request.user == object.user %}
                            {% endif %}
                            {% endcomment %}

                            <a class="btn btn-default auto" data-slug="{{ object.slug }}" data-toggle="modal" data-target="#modal_embed_look">{% trans "Embed on your site" %}</a>

                            {% include 'apparel/fragments/share.html' %}
                    </section>

                        </div>

                    <div class="col-lg-6">
                        {% if looks_by_user %}
                        <section class="center-sm">
                            <h4>{% trans "More looks by" %} {{ object.user.display_name }}</h4>
                            <hr>
                            <ul class="list-unstyled list-looks">
                                {% for look in looks_by_user %}
                                <li class="col-list-look">
                                    {% cache CACHE_TIMEOUT look_small_like_product look.id LANGUAGE_CODE %}
                                    <a title="{{ look.title }}" href="{% url 'look-detail' slug=look.slug %}">
                                        <div class="look-small {% if look.display_with_component == 'P' %}look-photo{% else %}look-collage{% endif %}">
                                            {% thumbnail look.static_image "300x226" is_collage=look.is_collage keep_size=True crop=False format="PNG" as im %}
                                            <img id="look-{{ look.id }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" />
                                            {% endthumbnail %}
                                        </div>
                                    </a>
                                    {% endcache %}
                                </li>
                                {% endfor %}
                            </ul>
                            <a class="btn btn-default auto" href="{% url 'profile-looks' object.user.slug %}">{% blocktrans with firstname=object.user.first_name %}See all looks by {{firstname}}{% endblocktrans %}</a>
                        </section>
                        {% endif %}

                        <section class="center-sm">
                            {% cache CACHE_TIMEOUT look_detail_likes object.id LANGUAGE_CODE %}
                                <h4>{% trans "Likes" %} </h4>
                                    <hr>
                                        <ul id="likes-box" class="list-inline list-likes">
                                            <li class="{% if likes %}hide{% endif %}" style="width:inherit;">{% trans "Be the first one to like this look!" %}</li>
                                            {% for like in likes %}
                                                <li data-user-id="{{ like.user.pk }}"><a href="{{ like.user.get_absolute_url }}" title="{{ like.user.display_name }}">
                                                    <img class="img-circle" alt="{{ like.user.display_name }}" title="{{ like.user.display_name }}" src="{{ like.user.avatar }}"></a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                            {% endcache %}
                        </section>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {% include 'apparel/modal_look_delete.html' with look=object only %}
    {% include 'apparel/modal_look_publish.html' with look=object only %}
    {% include 'apparel/modal_look_unpublish.html' with look=object only %}

    {% block body-scripts %}
        <script>
            $("#modal_embed_look").load("{% url 'dialog-look-embed' object.slug %}");
        </script>
    {% endblock body-scripts %}

{% endblock %}
