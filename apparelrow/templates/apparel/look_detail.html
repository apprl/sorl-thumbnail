{% extends 'base.html' %}
{% load i18n humanize comments cache apparel_extras thumbnail %}

{% block extra-title %}{{ object.title }} {% trans "by" %} {{ object.user.display_name }} | {% trans "Looks" %} | {% endblock %}

{% block head-data %} prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# {{ FACEBOOK_OG_TYPE }}: http://ogp.me/ns/fb/{{ FACEBOOK_OG_TYPE }}#"{% endblock head-data %}

{% block extra-styles %}
    {% cache CACHE_TIMEOUT look_detail_metaextra object.id LANGUAGE_CODE %}
    <link rel="canonical" href="{{ object_url }}">
    <meta property="og:title" content="{{ object.title }}"/>
    <meta property="og:type" content="{{ FACEBOOK_OG_TYPE }}:look"/>
    <meta property="og:image" content="{{ look_full_image }}"/>
    <meta property="og:url" content="{{ object_url }}"/>
    <meta property="og:description" content="{% if object.product_brands_unique %}{{ object.product_brands_unique|join:", " }}{% endif %}"/>
    <meta property="og:site_name" content="{{ CURRENT_NAME }}"/>
    <meta property="fb:app_id" content="{{ FACEBOOK_APP_ID }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:likes" content="{{ object.score }}"/>
    <meta property="{{ FACEBOOK_OG_TYPE }}:products" content="{{ components|length }}"/>
    {% endcache %}
{% endblock extra-styles %}

{% block 'extra-scripts' %}
<script type="text/javascript">
    $(document).ready(function() {
        var popover_elements = $('[data-toggle=popover]');
        var is_touch_device = ("ontouchstart" in window) || window.DocumentTouch && document instanceof DocumentTouch;
        var timeout = null;

        popover_elements.each(function(i, element) {
            $(element).popover({
                html: true,
                trigger: 'manual',
                content: $(element).next().html()
            });
        });

        $(document).on('click', function(e) {
            popover_elements.popover('hide');
        });

        if(!is_touch_device) {
            $(document).on('mouseenter', '.popover', function() { clearTimeout(timeout); });
            popover_elements.on('mouseenter', function() {
                clearTimeout(timeout);
                var $element = $(this);
                popover_elements.not($element).popover('hide');
                $element.popover('show');
            }).on('mouseleave', function (e) {
                var $element = $(this);
                timeout = setTimeout(function() { $element.popover('hide'); }, 400);
            });
        }

        popover_elements.on('click', function(e) {
            var $element = $(this);
            popover_elements.not($element).popover('hide');
            if(is_touch_device) {
                $element.popover('show');
                return false;
            }
        });

        jQuery('#look-header .btn-delete').click(function(event) {
            var title = jQuery(this).attr('title');
            var href = jQuery(this).attr('href');
            create_modal_dialog(
                '{% trans "Are you sure?" %}',
                ['{% trans "Do you really want to delete look" %} <span class="bold">' + title + '</span>?'],
                function (modal_dialog) { location.href = href; },
                function (modal_dialog) { modal_dialog.close(); }
            );
            event.preventDefault();
        });

        $('#look-header')
            .on('click', '.btn-publish', function(e) {
                var $this = $(this);
                var text = $this.text();
                var href = $this.attr('href');
                var new_text = $this.data('text');
                var new_href = $this.data('href');
                create_modal_dialog(
                    '{% trans "Publish look" %}',
                    ['{% trans "Do you want to publish this look?" %}'],
                    function (modal_dialog) {
                        $.ajax({url: href,
                                success: function(data) {
                                    $this.data('text', text);
                                    $this.data('href', href);
                                    $this.text(new_text).attr('href', new_href).addClass('btn-unpublish').removeClass('btn-publish');
                                    if(share_settings['create_look'] === false) {
                                        ApparelActivity.notification('create', 'look', {{ object.id }});
                                    }
                                },
                                complete: function() { modal_dialog.close(); }
                            });
                    },
                    function (modal_dialog) { modal_dialog.close(); }
                );
                return false;
            })
            .on('click', '.btn-unpublish', function(e) {
                var $this = $(this);
                var text = $this.text();
                var href = $this.attr('href');
                var new_text = $this.data('text');
                var new_href = $this.data('href');
                create_modal_dialog(
                    '{% trans "Unpublish look?" %}',
                    ['{% trans "Are you sure you want to unpublish this look so that no one can see it?" %}'],
                    function (modal_dialog) {
                        $.ajax({url: href,
                            success: function(data) {
                                    $this.data('text', text);
                                    $this.data('href', href);
                                    $this.text(new_text).attr('href', new_href).addClass('btn-publish').removeClass('btn-unpublish');
                                },
                                complete: function() { modal_dialog.close(); }
                            });
                    },
                    function (modal_dialog) { modal_dialog.close(); }
                );
                return false;
            });

        {% if look_created %}
        try {
            _gaq.push(['_trackEvent', 'Look', 'Create', '{{ object.title }}']);
        } catch(err){}
        {% endif %}

        {% if look_saved %}
        ApparelActivity.notification('create', 'look', {{ object.id }});
        {% endif %}
    });

</script>
{% endblock 'extra-scripts' %}

{% block meta_description %}
    {% cache CACHE_TIMEOUT look_detail_metadesc object.id LANGUAGE_CODE %}
    {% if object.description %}{{ object.description }} - {% endif %}{{ object.category_and_brand|join:', ' }}
    {% endcache %}
{% endblock %}

{% block body-classes %}look-detail-page{% endblock body-classes %}
{% block full-body %}


    <div class="container" itemscope itemtype="http://data-vocabulary.org/Product">
        <div class="body-header">
            <div class="body-header-col-full">
                <div class="float-container">
                <h1>{{ object.title }}{% if not object.published %} ({% trans "Draft" %}){% endif %}</h1>
                {% if request.user.is_authenticated %}
                <a class="btn btn-primary btn-look-like{% if is_liked %} liked{% endif %}" href="#" data-liked-text="{% trans "Liked" %}" data-unlike-text="{% trans "Unlike" %}" data-like-text="{% trans "Like" %}" data-like-url="{% url 'look-like' object.slug 'like' %}" data-unlike-url="{% url 'look-like' object.slug 'unlike' %}" data-slug="{{ object.slug }}" data-id="{{ object.id }}"><span>{% if is_liked %}{% trans "Liked" %}{% else %}{% trans "Like" %}{% endif %}</span>&nbsp;<span class="glyphicon glyphicon-heart"></span></a>
                {% else %}
                <a class="btn btn-primary" data-toggle="modal" href="#" data-target="#modal_like_look"><span>{% trans "Like" %}</span> <span class="glyphicon glyphicon-heart"></span></a>
                {% endif %}
                </div>
                <h2>{% trans "by" %} <a href="{{ object.user.get_absolute_url }}">{{ object.user.display_name }}</a></h2>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">

                <div class="look-main-content">
                    {% if object.user != request.user %}
                    {% else %}
                    <a class="btn btn-edit" href="{% url 'look-editor' object.slug %}">{% trans "Edit" %}</a>
                    <a class="btn btn-delete" title="{{ object.title }}" href="{% url 'look-delete' object.slug %}">{% trans "Delete" %}</a>
                    {% if object.published %}
                    <a class="btn btn-unpublish" data-href="{% url 'look-publish' object.slug %}" data-text="{% trans "Publish" %}" title="{{ object.title }}" href="{% url 'look-unpublish' object.slug %}">{% trans "Unpublish" %}</a>
                    {% else %}
                    <a class="btn btn-publish" data-href="{% url 'look-unpublish' object.slug %}" data-text="{% trans "Unpublish" %}" title="{{ object.title }}" href="{% url 'look-publish' object.slug %}">{% trans "Publish" %}</a>
                    {% endif %}
                    {% endif %}

                    {% cache CACHE_TIMEOUT look_detail_content object.id LANGUAGE_CODE %}
                    {% if object.display_with_component == 'C' %}
                    <div class="look-large collage">

                        <div id="collage-background" class="look-collage">
                            {% thumbnail object.image "720" upscale=True as im %}
                            <img class="img-responsive" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                            {% endthumbnail %}
                            {% for component in object.collage_components.all %}
                                {% thumbnail component.product.product_image "224x291" crop=False format="PNG" transparent=True as im %}
                                <a href="{{ component.product.get_absolute_url }}" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="click" class="product collage-image" style="{{ component.style_percentage }}">
                                    <img src="{{ im.url }}" title="{{ component.product }}" style="width:{{ im.width }}px;height:{{im.height}}px;" class="img-responsive" />
                                </a>
                                {% endthumbnail %}
                                {% include "apparel/fragments/look_product_tooltip.html" with owner=object.user product=component.product only %}
                            {% endfor %}
                        </div>

                    </div>
                    {% else %}
                    <div class="look-large photo">

                        {% thumbnail object.image "720" upscale=False as im %}
                        <div id="photo-background" class="look-photo" style="max-width: {{ im.width }}px;">
                            <img class="img-responsive" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}">
                            {% for component in components %}
                                <a href="{{ component.product.get_absolute_url }}" data-container="body" data-toggle="popover" data-placement="auto" data-trigger="click" class="hotspot product" style="{% look_component_style component im.width im.height %}"></a>
                                {% include "apparel/fragments/look_product_tooltip.html" with owner=object.user product=component.product only %}
                            {% endfor %}
                        </div>
                        {% endthumbnail %}

                    </div>
                    {% endif %}
                    {% endcache %}

                    {% if object.description %}
                    <p>{{ object.description }}</p>
                    {% endif %}
                </div>

            </div>
            <div class="col-md-6">

                <div class="row">
                    <div class="col-lg-6">


                        {% cache CACHE_TIMEOUT look_detail object.id LANGUAGE_CODE %}
                        <h3>{% trans "Look details" %}</h3>
                        <ul class="brands list-unstyled">
                            {% for text, product in object.category_and_brand_with_product %}
                            <li><a href="{% internal_referral_url product.get_absolute_url object.user.pk %}">{{ text }}</a></li>
                            {% endfor %}
                        </ul>

                        <p class="total-price">
                            <span class="price">
                                {% blocktrans count object.category_and_brand_count as number %}{{ number }} article{% plural %}{{ number }} articles{% endblocktrans %}
                            </span>
                            {% if object.category_and_brand_count > 0 %}
                            <span class="sum"> - {{ object.total_price|floatformat:0|apprl_intcomma }} {{ CURRENCY }}</span>
                            {% endif %}
                        </p>
                        <p class="created">{% trans "Created" %} {{ object.created|since }}</p>

                        {% if request.user == object.user %}
                        <a href="{% url 'dialog-look-embed' object.slug %}" class="btn btn-primary btn-block btn-embed" data-slug="{{ object.slug }}" data-toggle="modal" data-target="#modal_embed_look">{% trans "Embed on your blog / site" %}</a>
                        {% endif %}

                        {% include 'apparel/fragments/share.html' %}
                        {% endcache %}

                    </div>
                    <div class="col-lg-6">

                        {% if looks_by_user %}
                        <h3>{% trans "More looks by" %} {{ object.user.display_name }}</h3>
                        <ul class="list-unstyled list-looks">
                            {% for look in looks_by_user %}
                            <li class="col-list-look">
                                {% cache CACHE_TIMEOUT look_small_like_product look.id LANGUAGE_CODE %}
                                <a title="{{ look.title }}" href="{% url 'look-detail' slug=look.slug %}">
                                    <div class="look-small {% if look.display_with_component == 'P' %}look-photo{% else %}look-collage{% endif %}">
                                        {% thumbnail look.static_image "300x226" is_collage=look.is_collage keep_size=True crop=False format="PNG" as im %}
                                        <img id="look-{{ look.id }}" src="{{ im.url }}" width="{{ im.width }}" height="{{ im.height }}" class="img-responsive" />
                                        {% endthumbnail %}
                                    </div>
                                </a>
                                {% endcache %}
                            </li>
                            {% endfor %}
                        </ul>
                        <a class="btn btn-primary btn-block" href="{% url 'profile-looks' object.user.slug %}">{% blocktrans with firstname=object.user.first_name %}See all looks by {{firstname}}{% endblocktrans %}</a>
                        {% endif %}

                        {% cache CACHE_TIMEOUT look_detail_likes object.id LANGUAGE_CODE %}
                        <h3>{% trans "Likes" %}</h3>
                        <ul id="likes-box" class="list-inline list-likes">
                            <li{% if likes %} class="hide"{% endif %}><p>{% trans "Be the first one to like this look!" %}</p></li>
                            {% for like in likes %}
                            <li data-user-id="{{ like.user.pk }}"><a href="{{ like.user.get_absolute_url }}" title="{{ like.user.display_name }}"><img class="img-circle" alt="{{ like.user.display_name }}" title="{{ like.user.display_name }}" src="{{ like.user.avatar }}"></a></li>
                            {% endfor %}
                        </ul>
                        {% endcache %}

                    </div>
                </div>

            </div>
        </div>
    </div>

{% endblock %}
