{% extends 'base.html' %}
{% load i18n l10n cache dashboard_extras %}
{% load static from staticfiles %}

{% block extra-title %}{% trans "Publisher" %} | {% endblock %}
{% block 'extra-scripts' %}
    <script type="text/javascript" src="{% static "js/vendor/tablesort.min.js" %}"></script>
    <script type='text/javascript'>
        $(document).ready(function() {
            $('.month-select').change(function() {
                var month = $('.month-select').find(':selected').data('month');
                var year = $('.year-select').find(':selected').data('year');
                window.location.href = '/publisher/product/' + year + '/' + month + '/';

            });
            $('.year-select').change(function() {
                var month = $('.month-select').find(':selected').data('month');
                var year = $('.year-select').find(':selected').data('year');
                window.location.href = '/publisher/product/' + year + '/' + month + '/';
            });
            new Tablesort($('table#top-products').get(0));
        });
    </script>
{% endblock %}

{% block body-classes %}publisher-page{% endblock body-classes %}
{% block body %}
    {% include 'dashboard/body_header.html' %}
    <div class="row subnav-page">
        <div class="col-sm-3">{% trans "Pending commission: " %}<strong>{{ sales_pending|floatformat:2 }} {{ currency }}</strong></div>
        <div class="col-sm-3"><span class="glyphicon glyphicon-arrow-right"></span> {% trans "Confirmed commission: " %}<strong>{{ total_confirmed|floatformat:2 }} {{ currency }}</strong></div>
        <div class="col-sm-3"><span class="glyphicon glyphicon-arrow-right"></span> {% trans "Pending payment: " %}<strong>{{ pending_payment|floatformat:2 }} {{ currency }}</strong></div>
        <div class="col-sm-3"><a data-toggle="modal" href="#modal_publisher_info">{% trans "How payments work" %}</a></div>
        <div class="col-sm-12" style="border-bottom: 2px solid #DDD; text-align:center; margin:10px; padding-bottom: 45px;">{% trans "In total, " %}<strong>{{ total_earned }} {{ currency }}</strong> {% trans "has been paid out to you" %}</div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <ul class="list-inline monthly-list">
                <li>
                <label>{% trans "Show statistics for: " %}
                    <select class="month-select">
                        {% for item_month in months_choices %}
                        <option data-month="{{ item_month.0 }}"{% if item_month.0 == month %} selected{%endif %}>{{ item_month.1 }}</option>
                        {% endfor %}
                    </select>
                    <select class="year-select">
                        {% for item_year in years_choices %}
                        <option data-year="{{ item_year }}" {% if item_year == year %} selected{%endif %}>{{ item_year }}</option>
                        {% endfor %}
                    </select>
                </label>
                </li>
            </ul>
            <ul class="list-inline monthly-list">
                <li>{% blocktrans %}Your commission: {{ month_commission }} {{ currency }}{% endblocktrans %}</li>
                <li>{% blocktrans %}Clicks: {{month_clicks}}{% endblocktrans %}</li>
                <li>{% blocktrans %}Sales: {{month_sales}}{% endblocktrans %}</li>
                <li>{% blocktrans with conversion_rate=month_conversion_rate|floatformat:2 %}Conversion rate: {{ conversion_rate }}%{% endblocktrans %}</li>
            </ul>


            {% if request.user.referral_partner %}
            <ul class="list-inline monthly-list">
                <li>{% blocktrans %}Referral commission: {{ referral_commission }} {{ currency }}{% endblocktrans %}</li>
                <li>{% blocktrans %}Referrals: {{referral_sales}}{% endblocktrans %}</li>
            </ul>
            {% endif %}
            {% if network_sales %}
            <ul class="list-inline monthly-list">
                <li>{% blocktrans %}Network commission: {{ network_commission }} {{ currency }}{% endblocktrans %}</li>
                <li>{% blocktrans %}Network sales: {{ network_sales }}{% endblocktrans %}</li>
            </ul>
            {% endif %}


        </div>
    </div>
    <div class="row">
        <div class="col-lg-10 col-md-6 col-sm-6"><h2>{% trans "All products" %}</h2></div>
        <div class="col-lg-2 col-md-6 col-sm-6 text-right hidden-xs"><h2><small><a href="{% url 'dashboard' %}">{% trans "Back to dashboard" %}</a></small></h2></div>
        <table id="top-products" class="sortable table">
            <thead>
                <tr>
                    <th class="col1 product-image center">{% trans "Product" %}</th>
                    <th class="col2 hidden-xs center"></th>
                    <th class="col3 center hidden-xs center">{% trans "Clicks" %}</th>
                    <th class="center">{% trans "Sales" %}</th>
                    <th class="center">{% trans "Conversion rate" %}</th>
                    <th class="hidden-xs center">{% trans "Sales generated" %}</th>
                    <th class="hidden-xs center">{% trans "Earnings" %}</th>
                    {% if is_owner %}
                        <th class="center">{% trans "Network earnings" %}</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for product in most_sold_products %}
                <tr>
                    <td data-sort="{{ product.product }}" class="col1 product-image center"><a href="{{ product.product_link }}"><img src="{{ product.product_image }}"></a></td>
                    <td class="col2 hidden-xs"><a href="{{ product.product_link }}">{{ product.product }}</a></td>
                    <td class="col3 center hidden-xs">{{ product.clicks }}</td>
                    <td class="center">{{ product.sales }}</td>
                    <td class="center">{{ product.sales|commission_rate:product.clicks }}</td>
                    <td class="hidden-xs center">{{ product.converted_amount }} {{ currency }}</td>
                    <td class="hidden-xs center">{{ product.publisher_earnings }} {{ currency }}</td>
                    {% if is_owner %}
                        <td class="center">{{ product.network_earnings }} {{ currency }}</td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">{% trans "No sales yet." %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% include 'dashboard/modal_more_info.html' %}
{% endblock body %}